<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Profiles - VVPIET</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #fff; color: #000; padding-bottom: 80px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; padding: 20px 0; border-bottom: 2px solid #8B5CF6; position: relative; }
        .header h1 { font-size: 24px; color: #8B5CF6; }
        .page { display: none; }
        .page.active { display: block; }
        .back-btn { background: #8B5CF6; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-bottom: 20px; }
        
        .staff-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
        .staff-card { border: 2px solid #8B5CF6; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; transition: transform 0.3s; }
        .staff-card:hover { transform: translateY(-5px); }
        .staff-card img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; }
        .staff-card .name { font-weight: 600; margin: 10px 0 5px; }
        .staff-card .designation { color: #666; font-size: 14px; }
        
        .form-container { max-width: 600px; margin: 0 auto; padding: 30px; background: #f9f9f9; border-radius: 10px; border: 2px solid #8B5CF6; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 2px solid #8B5CF6; border-radius: 8px; font-size: 14px; }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-btn { width: 100%; padding: 15px; background: #8B5CF6; color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .form-btn:hover { opacity: 0.9; }
        
        .profile-view { max-width: 800px; margin: 0 auto; }
        .profile-header { text-align: center; padding: 30px 0; border-bottom: 2px solid #8B5CF6; }
        .profile-header img { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid #8B5CF6; }
        .profile-header .name { font-size: 28px; font-weight: 600; margin: 20px 0 10px; }
        .profile-header .dept { color: #8B5CF6; font-size: 18px; }
        .profile-content { padding: 30px 0; }
        .profile-field { margin-bottom: 25px; }
        .profile-field-label { font-weight: 600; color: #8B5CF6; margin-bottom: 8px; }
        .profile-field-value { color: #333; line-height: 1.6; }
        
        .action-btns { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 30px; }
        .action-btn { flex: 1; min-width: 150px; padding: 12px; border: 2px solid #8B5CF6; background: #fff; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .action-btn:hover { background: #8B5CF6; color: #fff; }
        .delete-btn { border-color: #dc2626; color: #dc2626; }
        .delete-btn:hover { background: #dc2626; color: #fff; }
        
        .taskbar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 2px solid #8B5CF6; display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; }
        .taskbar button { background: none; border: none; cursor: pointer; padding: 8px 20px; font-size: 13px; color: #000; }
        .taskbar .icon { font-size: 20px; margin-bottom: 5px; }
        
        .posts-section { margin-top: 40px; border-top: 2px solid #8B5CF6; padding-top: 30px; }
        .posts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .post-card { border: 2px solid #8B5CF6; border-radius: 10px; overflow: hidden; position: relative; }
        .post-card img { width: 100%; height: 200px; object-fit: cover; }
        .post-card .caption { padding: 15px; }
        .post-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        .post-actions button { background: rgba(255,255,255,0.9); border: none; padding: 8px; border-radius: 5px; cursor: pointer; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: #fff; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; border: 2px solid #8B5CF6; position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; }
        
        input[type="file"] { margin: 15px 0; }
        .custom-field { display: flex; gap: 10px; margin-bottom: 10px; }
        .custom-field input { flex: 1; }
        .custom-field button { padding: 8px 15px; background: #dc2626; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    
        

        /* Enhanced post card styling */
.post-card {
    position: relative;
    border: 2px solid #8B5CF6;
    border-radius: 12px;
    overflow: hidden;
    background: white;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}


.post-image-container {
    position: relative;
    width: 100%;
    height: 200px;
    overflow: hidden;
}

.post-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.post-card:hover .post-img {
    transform: scale(1.05);
}

.post-caption {
    padding: 15px;
    font-size: 14px;
    line-height: 1.4;
    color: #333;
    border-bottom: 1px solid #f0f0f0;
}

.post-actions {
    display: flex;
    justify-content: space-between;
    padding: 10px 15px;
    background: #f8f9fa;
    gap: 10px;
}

.post-actions button {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.edit-btn {
    background: #8B5CF6;
    color: white;
}


.delete-btn {
    background: #EF4444;
    color: white;
}



.post-date {
    padding: 0 15px 10px;
    text-align: right;
}

/* Edit modal specific styling */
.current-image-section {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}

.form-actions {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .post-actions {
        flex-direction: column;
        gap: 8px;
    }
    
    .post-actions button {
        flex: none;
    }
}

    
    </style>
</head>
<body>
    <div class="container">
        <!-- Department View -->
        <div id="deptPage" class="page">
            <button class="back-btn" onclick="location.href='staffprof.html'">← Back</button>
            <div class="header">
                <h1 id="deptName">Department</h1>
            </div>
            <h3 style="margin-top:30px;color:#8B5CF6;">Head of Department</h3>
            <div class="staff-grid" id="hodGrid"></div>
            <h3 style="margin-top:30px;color:#8B5CF6;">Staff Members</h3>
            <div class="staff-grid" id="staffGrid"></div>
        </div>
        
        <!-- View Profile (Staff/TPO) -->
        <div id="viewProfilePage" class="page">
            <button class="back-btn" onclick="goBack()">← Back</button>
            <div class="profile-view">
                <div class="profile-header" id="viewProfileHeader"></div>
                <div class="profile-content" id="viewProfileContent"></div>
                <div class="posts-section" id="viewProfilePosts" style="display:none;">
                    <h3 style="color:#8B5CF6;">Posts</h3>
                    <div class="posts-grid" id="viewPostsGrid"></div>
                </div>
            </div>
        </div>
        
        <!-- Login Page -->
        <div id="loginPage" class="page">
            <div class="form-container">
                <button class="back-btn" onclick="location.href='staffprof.html'">← Back</button>
                <h2 style="text-align:center;color:#8B5CF6;margin-bottom:30px;">Staff Login</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="loginPassword" required>
                    </div>
                    <button type="submit" class="form-btn">Login</button>
                </form>
                <p style="text-align:center;margin-top:20px;">New user? <a href="#" onclick="showPage('registerPage');return false;" style="color:#8B5CF6;">Register</a></p>
            </div>
        </div>
        
        <!-- Register Page -->
        <div id="registerPage" class="page">
            <div class="form-container">
                <button class="back-btn" onclick="showPage('loginPage')">← Back</button>
                <h2 style="text-align:center;color:#8B5CF6;margin-bottom:30px;">Staff Registration</h2>
                <form id="registerForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="regEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="regPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <select class="form-select" id="regDept" required></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department Code (6 digits)</label>
                        <input type="text" class="form-input" id="regCode" maxlength="6" required>
                    </div>
                    <button type="submit" class="form-btn">Register</button>
                </form>
            </div>
        </div>
        
        <!-- My Profile -->
        <div id="myProfilePage" class="page">
            <button class="back-btn" onclick="location.href='staffprof.html'">← Back</button>
            <div id="noProfile" style="text-align:center;padding:50px;">
                <p style="margin-bottom:20px;">Create your profile to get started.</p>
                <button class="form-btn" style="width:200px;margin:0 auto;" onclick="showPage('createProfilePage')">Create Profile</button>
            </div>
            <div id="hasProfile" style="display:none;">
                <div class="profile-view">
                    <div class="profile-header" id="myProfileHeader"></div>
                    <div class="profile-content" id="myProfileContent"></div>
                    <div class="action-btns">
                        <button class="action-btn" onclick="editProfile()">✏️ Edit</button>
                        <button class="action-btn" onclick="downloadPDF()">📄 PDF</button>
                        <button class="action-btn" onclick="downloadImage()">🖼️ Image</button>
                        <button class="action-btn delete-btn" onclick="deleteProfile()">🗑️ Delete</button>
                    </div>
                    <div class="posts-section">
                        <h3 style="color:#8B5CF6;">My Posts</h3>
                        <button class="form-btn" style="width:200px;margin:20px 0;" onclick="showAddPost()">+ Add Post</button>
                        <div class="posts-grid" id="myPosts"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Create/Edit Profile -->
        <div id="createProfilePage" class="page">
            <div class="form-container">
                <button class="back-btn" onclick="showPage('myProfilePage')">← Back</button>
                <h2 style="text-align:center;color:#8B5CF6;margin-bottom:30px;" id="profileFormTitle">Create Profile</h2>
                <form id="profileForm">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="profName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <select class="form-select" id="profDept" required></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Designation</label>
                        <select class="form-select" id="profDesig" required>
                            <option value="">Select</option>
                            <option value="HOD">Head of Department</option>
                            <option value="Professor">Professor</option>
                            <option value="Associate Professor">Associate Professor</option>
                            <option value="Assistant Professor">Assistant Professor</option>
                            <option value="Lecturer">Lecturer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Experience (Years)</label>
                        <input type="number" class="form-input" id="profExp" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Expertise</label>
                        <textarea class="form-textarea" id="profResearch"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Achievements</label>
                        <textarea class="form-textarea" id="profAchieve"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Custom Fields</label>
                        <div id="customFields"></div>
                        <button type="button" onclick="addCustomField()" style="margin-top:10px;padding:10px 20px;background:#8B5CF6;color:#fff;border:none;border-radius:5px;cursor:pointer;">+ Add Field</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Profile Image (Optional)</label>
                        <input type="file" id="profImage" accept="image/*">
                    </div>
                    <button type="submit" class="form-btn">Save Profile</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Post Modal -->
    <div class="modal" id="postModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closePostModal()">×</button>
            <h3 style="color:#8B5CF6;margin-bottom:20px;">Add Post</h3>
            <form id="postForm">
                <div class="form-group">
                    <label class="form-label">Image</label>
                    <input type="file" id="postImage" accept="image/*" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Caption</label>
                    <textarea class="form-textarea" id="postCaption"></textarea>
                </div>
                <button type="submit" class="form-btn">Post</button>
            </form>
        </div>
    </div>
    <!-- Edit Post Modal -->
<div class="modal" id="editPostModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeEditPostModal()">×</button>
        <h3 style="color:#8B5CF6;margin-bottom:20px;">Edit Post</h3>
        <form id="editPostForm">
            <div class="current-image-section" style="margin-bottom:20px;">
                <label class="form-label">Current Image</label>
                <div style="text-align:center;">
                    <img id="currentPostImage" src="" alt="Current post" style="max-width:100%;max-height:200px;border-radius:8px;border:2px solid #8B5CF6;">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Change Image (Optional)</label>
                <input type="file" id="editPostImage" accept="image/*">
                <small style="color:#666;">Leave empty to keep current image</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Caption</label>
                <textarea class="form-textarea" id="editPostCaption" rows="4"></textarea>
            </div>
            
            <div class="form-actions" style="display:flex;gap:10px;justify-content:flex-end;">
                <button type="button" onclick="closeEditPostModal()" style="background:#ccc;color:#333;padding:12px 24px;border:none;border-radius:5px;cursor:pointer;">Cancel</button>
                <button type="submit" class="form-btn">Update Post</button>
            </div>
        </form>
    </div>
</div>


    
    <div class="taskbar">
        <button onclick="location.href='staffprof.html'">
            <div class="icon">🏠</div>
            <span>Home</span>
        </button>
        <button onclick="handleProfile()">
            <div class="icon">👤</div>
            <span>Profile</span>
        </button>
        <button onclick="handleAuth()">
            <div class="icon">🚪</div>
            <span id="authText">Login</span>
        </button>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        const sb = supabase.createClient('https://nsnacwwcrszpjmanskti.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zbmFjd3djcnN6cGptYW5za3RpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MTg2MTIsImV4cCI6MjA2ODQ5NDYxMn0.W01JADzAuGFvcAHAN6LPRIxc75J7A9Q76HIxvxkJDn4');
        
        let currentUser = JSON.parse(localStorage.getItem('user'));
        let editingProfile = false;
        let backHistory = [];
        
        function showPage(pageId) {
            backHistory.push(document.querySelector('.page.active')?.id);
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }
        
        function goBack() {
            const prev = backHistory.pop();
            if (prev) showPage(prev);
            else location.href = 'staffprof.html';
        }
        
        async function loadDepartment() {
            const params = new URLSearchParams(location.search);
            const dept = params.get('dept');
            if (!dept) return;
            
            const { data: depts } = await sb.from('departments').select('*');
            const deptInfo = depts?.find(d => d.dept_short_name === dept);
            if (!deptInfo) return;
            
            document.getElementById('deptName').textContent = deptInfo.dept_name;
            
            const { data: profiles } = await sb.from('profiles').select('*').eq('department', deptInfo.dept_id).eq('is_published', true);
            
            const hods = profiles?.filter(p => p.designation === 'HOD') || [];
            const staff = profiles?.filter(p => p.designation !== 'HOD') || [];
            
            document.getElementById('hodGrid').innerHTML = hods.map(renderStaffCard).join('') || '<p style="text-align:center;color:#666;">No HOD assigned</p>';
            document.getElementById('staffGrid').innerHTML = staff.map(renderStaffCard).join('') || '<p style="text-align:center;color:#666;">No staff members</p>';
            
            showPage('deptPage');
        }
        
        function renderStaffCard(profile) {
            const initials = profile.name.split(' ').map(n => n[0]).join('').substring(0, 2);
            const img = profile.profile_image || `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80'%3E%3Crect fill='%238B5CF6' width='80' height='80'/%3E%3Ctext x='50%25' y='50%25' font-size='32' fill='white' text-anchor='middle' dy='.3em'%3E${initials}%3C/text%3E%3C/svg%3E`;
            return `<div class="staff-card" onclick="viewProfile('${profile.profile_id}')">
                <img src="${img}" alt="${profile.name}">
                <div class="name">${profile.name}</div>
                <div class="designation">${profile.designation}</div>
            </div>`;
        }
        
        async function viewProfile(id) {
            const { data } = await sb.from('profiles').select('*').eq('profile_id', id).single();
            if (!data) return;
            
            const { data: dept } = await sb.from('departments').select('dept_name').eq('dept_id', data.department).single();
            const { data: posts } = await sb.from('posts').select('*').eq('author_id', data.user_id).eq('author_type', 'staff').eq('is_published', true).order('created_at', { ascending: false });
            
          // FIND this part in loadMyProfile and REPLACE it
const initials = data.name.split(' ').map(n => n[0]).join('').substring(0, 2);
const img = data.profile_image || `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150'%3E%3Crect fill='%238B5CF6' width='150' height='150'/%3E%3Ctext x='50%25' y='50%25' font-size='60' fill='white' text-anchor='middle' dy='.3em'%3E${initials}%3C/text%3E%3C/svg%3E`;

document.getElementById('myProfileHeader').innerHTML = `
    <img src="${img}" alt="${data.name}" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #8B5CF6;">
    <div class="name">${data.name}</div>
    <div class="dept">${dept?.dept_name || ''}</div>
`;

            
            document.getElementById('viewProfileContent').innerHTML = `
                <div class="profile-field"><div class="profile-field-label">Designation</div><div class="profile-field-value">${data.designation}</div></div>
                <div class="profile-field"><div class="profile-field-label">Experience</div><div class="profile-field-value">${data.experience} years</div></div>
                <div class="profile-field"><div class="profile-field-label">Expertise</div><div class="profile-field-value">${data.research_papers || 'N/A'}</div></div>
                <div class="profile-field"><div class="profile-field-label">Achievements</div><div class="profile-field-value">${data.achievements || 'N/A'}</div></div>
                ${data.custom_fields ? Object.entries(data.custom_fields).map(([k, v]) => `<div class="profile-field"><div class="profile-field-label">${k}</div><div class="profile-field-value">${v}</div></div>`).join('') : ''}
            `;
            
            if (posts?.length) {
                document.getElementById('viewProfilePosts').style.display = 'block';
                document.getElementById('viewPostsGrid').innerHTML = posts.map(p => `
                    <div class="post-card">
                        <img src="${p.image_url}" alt="Post">
                        <div class="caption">${p.caption || ''}</div>
                    </div>
                `).join('');
            }
            
            showPage('viewProfilePage');
        }
        
        async function viewTPO() {
            const { data: tpo } = await sb.from('tpo').select('*').eq('is_active', true).single();
            if (!tpo) return alert('TPO profile not found');
            
            const { data: posts } = await sb.from('posts').select('*').eq('author_type', 'tpo').eq('is_published', true).order('created_at', { ascending: false });
            
            const img = tpo.profile_image || `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150'%3E%3Crect fill='%238B5CF6' width='150' height='150'/%3E%3Ctext x='50%25' y='50%25' font-size='60' fill='white' text-anchor='middle' dy='.3em'%3E${tpo.name[0]}%3C/text%3E%3C/svg%3E`;
            
            document.getElementById('viewProfileHeader').innerHTML = `
                <img src="${img}" alt="${tpo.name}">
                <div class="name">${tpo.name}</div>
                <div class="dept">Training & Placement Officer</div>
            `;
            
            document.getElementById('viewProfileContent').innerHTML = `
                <div class="profile-field"><div class="profile-field-label">Designation</div><div class="profile-field-value">${tpo.designation}</div></div>
                <div class="profile-field"><div class="profile-field-label">About</div><div class="profile-field-value">${tpo.description || 'N/A'}</div></div>
                ${tpo.contact_email ? `<div class="profile-field"><div class="profile-field-label">Email</div><div class="profile-field-value">${tpo.contact_email}</div></div>` : ''}
                ${tpo.contact_phone ? `<div class="profile-field"><div class="profile-field-label">Phone</div><div class="profile-field-value">${tpo.contact_phone}</div></div>` : ''}
            `;
            
            if (posts?.length) {
                document.getElementById('viewProfilePosts').style.display = 'block';
                document.getElementById('viewPostsGrid').innerHTML = posts.map(p => `
                    <div class="post-card">
                        <img src="${p.image_url}" alt="Post">
                        <div class="caption">${p.caption || ''}</div>
                    </div>
                `).join('');
            }
            
            showPage('viewProfilePage');
        }
        
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPassword').value;
            
            const { data } = await sb.from('users').select('*').eq('email', email).eq('password', pass).single();
            if (data) {
                localStorage.setItem('user', JSON.stringify(data));
                currentUser = data;
                location.href = 'stafflogin.html';
            } else {
                alert('Invalid credentials');
            }
        };
        
        document.getElementById('registerForm').onsubmit = async (e) => {
    e.preventDefault();
    const email = document.getElementById('regEmail').value;
    const pass = document.getElementById('regPassword').value;
    const dept = document.getElementById('regDept').value;
    const code = document.getElementById('regCode').value;
    
    const { data: deptData } = await sb.from('departments').select('*').eq('dept_id', dept).single();
    if (!deptData || deptData.dept_code !== code) {
        return alert('Invalid department code');
    }
    
    const { error } = await sb.from('users').insert({ 
        email, 
        password: pass, 
        department: dept, 
        role: 'Staff' // Changed from 'staff' to 'Staff'
    });
    if (error) return alert('Registration failed: ' + error.message);
    
    alert('Registration successful! Please login.');
    showPage('loginPage');
};

        
        async function loadDepartments() {
            const { data } = await sb.from('departments').select('*').order('dept_name');
            const html = '<option value="">Select Department</option>' + (data?.map(d => `<option value="${d.dept_id}">${d.dept_name}</option>`).join('') || '');
            document.querySelectorAll('#regDept, #profDept').forEach(el => el.innerHTML = html);
        }
        
        function handleAuth() {
            if (currentUser) {
                if (confirm('Logout?')) {
                    localStorage.removeItem('user');
                    location.reload();
                }
            } else {
                location.href = 'stafflogin.html';
                showPage('loginPage');
            }
        }
        
        function handleProfile() {
            if (!currentUser) return location.href = 'stafflogin.html';
            showPage('myProfilePage');
            loadMyProfile();
        }
        
        async function loadMyProfile() {
            const { data } = await sb.from('profiles').select('*').eq('user_id', currentUser.user_id).single();
            if (!data) {
                document.getElementById('noProfile').style.display = 'block';
                document.getElementById('hasProfile').style.display = 'none';
                return;
            }
            
            document.getElementById('noProfile').style.display = 'none';
            document.getElementById('hasProfile').style.display = 'block';
            
            const { data: dept } = await sb.from('departments').select('dept_name').eq('dept_id', data.department).single();
            const initials = data.name.split(' ').map(n => n[0]).join('').substring(0, 2);
            const img = data.profile_image || `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150'%3E%3Crect fill='%238B5CF6' width='150' height='150'/%3E%3Ctext x='50%25' y='50%25' font-size='60' fill='white' text-anchor='middle' dy='.3em'%3E${initials}%3C/text%3E%3C/svg%3E`;
            
            document.getElementById('myProfileHeader').innerHTML = `
                <img src="${img}" alt="${data.name}">
                <div class="name">${data.name}</div>
                <div class="dept">${dept?.dept_name || ''}</div>
            `;
            
            document.getElementById('myProfileContent').innerHTML = `
                <div class="profile-field"><div class="profile-field-label">Designation</div><div class="profile-field-value">${data.designation}</div></div>
                <div class="profile-field"><div class="profile-field-label">Experience</div><div class="profile-field-value">${data.experience} years</div></div>
                <div class="profile-field"><div class="profile-field-label">Expertise</div><div class="profile-field-value">${data.research_papers || 'N/A'}</div></div>
                <div class="profile-field"><div class="profile-field-label">Achievements</div><div class="profile-field-value">${data.achievements || 'N/A'}</div></div>
                ${data.custom_fields ? Object.entries(data.custom_fields).map(([k, v]) => `<div class="profile-field"><div class="profile-field-label">${k}</div><div class="profile-field-value">${v}</div></div>`).join('') : ''}
            `;
            
            // Replace this part in your loadMyProfile function:
const { data: posts } = await sb.from('posts').select('*').eq('author_id', currentUser.user_id).eq('author_type', 'staff').order('created_at', { ascending: false });

document.getElementById('myPosts').innerHTML = posts?.map(post => `
    <div class="post-card" id="post-${post.post_id}">
        <div class="post-image-container">
            <img src="${post.image_url}" alt="Post" class="post-img">
        </div>
        ${post.caption ? `<div class="post-caption">${post.caption}</div>` : ''}
        <div class="post-actions">
            <button onclick="editPost(${post.post_id})" class="edit-btn" title="Edit Post">
                ✏️ Edit
            </button>
            <button onclick="deletePost(${post.post_id})" class="delete-btn" title="Delete Post">
                🗑️ Delete
            </button>
        </div>
        <div class="post-date" style="font-size:12px;color:#666;margin-top:8px;">
            ${new Date(post.created_at).toLocaleDateString()}
        </div>
    </div>
`).join('') || '<p style="text-align:center;color:#666;">No posts yet</p>';

        }
        

        let currentEditingPost = null;

// Open edit post modal
async function editPost(postId) {
    try {
        // Fetch post data
        const { data: post, error } = await sb
            .from('posts')
            .select('*')
            .eq('post_id', postId)
            .single();
        
        if (error || !post) {
            return alert('Post not found');
        }
        
        // Check if user owns this post
        if (post.author_id !== currentUser.user_id) {
            return alert('You can only edit your own posts');
        }
        
        // Store current post data
        currentEditingPost = post;
        
        // Populate modal with current data
        document.getElementById('currentPostImage').src = post.image_url;
        document.getElementById('editPostCaption').value = post.caption || '';
        document.getElementById('editPostImage').value = ''; // Reset file input
        
        // Show modal
        document.getElementById('editPostModal').classList.add('show');
        
    } catch (error) {
        console.error('Error fetching post:', error);
        alert('Failed to load post data');
    }
}

// Close edit post modal
function closeEditPostModal() {
    document.getElementById('editPostModal').classList.remove('show');
    document.getElementById('editPostForm').reset();
    currentEditingPost = null;
}

// Handle edit post form submission
document.getElementById('editPostForm').onsubmit = async (e) => {
    e.preventDefault();
    
    if (!currentEditingPost) {
        return alert('No post selected for editing');
    }
    
    try {
        const newCaption = document.getElementById('editPostCaption').value;
        const newImageFile = document.getElementById('editPostImage').files[0];
        
        let updateData = {
            caption: newCaption,
            updated_at: new Date().toISOString()
        };
        
        // If user selected a new image, upload it
        if (newImageFile) {
            // Show loading indicator
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Uploading...';
            submitBtn.disabled = true;
            
            // Upload new image
            const fileName = `${currentUser.user_id}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${newImageFile.name.split('.').pop()}`;
            
            const { data: uploadData, error: uploadError } = await sb.storage
                .from('posts')
                .upload(fileName, newImageFile);
            
            if (uploadError) {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                throw uploadError;
            }
            
            // Get new image URL
            const { data: { publicUrl } } = sb.storage.from('posts').getPublicUrl(fileName);
            updateData.image_url = publicUrl;
            
            // Optional: Delete old image from storage
            try {
                const oldFileName = currentEditingPost.image_url.split('/').pop();
                await sb.storage.from('posts').remove([oldFileName]);
            } catch (deleteError) {
                console.log('Could not delete old image:', deleteError);
                // Continue anyway, as the main update is more important
            }
            
            // Reset button
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
        
        // Update post in database
        const { error: updateError } = await sb
            .from('posts')
            .update(updateData)
            .eq('post_id', currentEditingPost.post_id);
        
        if (updateError) throw updateError;
        
        alert('Post updated successfully! 🎉');
        closeEditPostModal();
        
        // Refresh the posts display
        loadMyProfile();
        
    } catch (error) {
        console.error('Error updating post:', error);
        alert('Failed to update post: ' + error.message);
        
        // Reset button if there was an error
        const submitBtn = e.target.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.textContent = 'Update Post';
            submitBtn.disabled = false;
        }
    }
};

// Enhanced delete post function with confirmation
async function deletePost(postId) {
    if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
        return;
    }
    
    try {
        // Get post data first to delete image from storage
        const { data: post } = await sb
            .from('posts')
            .select('image_url')
            .eq('post_id', postId)
            .single();
        
        // Delete post from database
        const { error: deleteError } = await sb
            .from('posts')
            .delete()
            .eq('post_id', postId);
        
        if (deleteError) throw deleteError;
        
        // Try to delete image from storage (optional, won't fail if error)
        if (post?.image_url && !post.image_url.startsWith('data:')) {
            try {
                const fileName = post.image_url.split('/').pop();
                await sb.storage.from('posts').remove([fileName]);
            } catch (storageError) {
                console.log('Could not delete image from storage:', storageError);
            }
        }
        
        alert('Post deleted successfully');
        
        // Remove post from UI immediately
        const postElement = document.getElementById(`post-${postId}`);
        if (postElement) {
            postElement.remove();
        }
        
        // Refresh posts if no posts remain
        const postsContainer = document.getElementById('myPosts');
        if (!postsContainer.querySelector('.post-card')) {
            postsContainer.innerHTML = '<p style="text-align:center;color:#666;">No posts yet</p>';
        }
        
    } catch (error) {
        console.error('Error deleting post:', error);
        alert('Failed to delete post: ' + error.message);
    }
};


        function editProfile() {
            editingProfile = true;
            document.getElementById('profileFormTitle').textContent = 'Edit Profile';
            sb.from('profiles').select('*').eq('user_id', currentUser.user_id).single().then(({ data }) => {
                if (data) {
                    document.getElementById('profName').value = data.name;
                    document.getElementById('profDept').value = data.department;
                    document.getElementById('profDesig').value = data.designation;
                    document.getElementById('profExp').value = data.experience;
                    document.getElementById('profResearch').value = data.research_papers || '';
                    document.getElementById('profAchieve').value = data.achievements || '';
                    
                    const customFieldsDiv = document.getElementById('customFields');
                    customFieldsDiv.innerHTML = '';
                    if (data.custom_fields) {
                        Object.entries(data.custom_fields).forEach(([k, v]) => {
                            const div = document.createElement('div');
                            div.className = 'custom-field';
                            div.innerHTML = `<input type="text" placeholder="Field Name" value="${k}" class="form-input"><input type="text" placeholder="Field Value" value="${v}" class="form-input"><button type="button" onclick="this.parentElement.remove()">✕</button>`;
                            customFieldsDiv.appendChild(div);
                        });
                    }
                }
                showPage('createProfilePage');
            });
        }
        
        // FIND this part in your profileForm submission and REPLACE it
document.getElementById('profileForm').onsubmit = async (e) => {
    e.preventDefault();
    
    const customFieldsData = {};
    document.querySelectorAll('#customFields .custom-field').forEach(field => {
        const inputs = field.querySelectorAll('input');
        if (inputs[0].value && inputs[1].value) {
            customFieldsData[inputs[0].value] = inputs[1].value;
        }
    });
    
    let imageUrl = null;
    const imageFile = document.getElementById('profImage').files[0];
    
    // REPLACE this image upload section
    if (imageFile) {
        try {
            const fileName = `profiles/${currentUser.user_id}_${Date.now()}_${Math.random().toString(36).substring(7)}.${imageFile.name.split('.').pop()}`;
            
            const { data: uploadData, error: uploadError } = await sb.storage
                .from('profile-images')
                .upload(fileName, imageFile, {
                    cacheControl: '3600',
                    upsert: false
                });
            
            if (uploadError) {
                console.error('Upload error:', uploadError);
                alert('Image upload failed: ' + uploadError.message);
                return;
            }
            
            const { data: { publicUrl } } = sb.storage.from('profile-images').getPublicUrl(fileName);
            imageUrl = publicUrl;
            
            console.log('Image uploaded successfully:', imageUrl);
            
        } catch (error) {
            console.error('Image upload error:', error);
            alert('Image upload failed');
            return;
        }
    }
    
    const profileData = {
        user_id: currentUser.user_id,
        name: document.getElementById('profName').value,
        department: parseInt(document.getElementById('profDept').value),
        designation: document.getElementById('profDesig').value,
        experience: parseInt(document.getElementById('profExp').value),
        research_papers: document.getElementById('profResearch').value,
        achievements: document.getElementById('profAchieve').value,
        custom_fields: customFieldsData,
        is_published: true
    };
    
    // ADD profile image if uploaded
    if (imageUrl) {
        profileData.profile_image = imageUrl;
    }
    
    try {
        if (editingProfile) {
            const { error } = await sb.from('profiles').update(profileData).eq('user_id', currentUser.user_id);
            if (error) throw error;
        } else {
            const { error } = await sb.from('profiles').insert(profileData);
            if (error) throw error;
        }
        
        alert('Profile saved successfully!');
        editingProfile = false;
        showPage('myProfilePage');
        loadMyProfile();
        
    } catch (error) {
        console.error('Profile save error:', error);
        alert('Failed to save profile: ' + error.message);
    }
};

        function addCustomField() {
            const div = document.createElement('div');
            div.className = 'custom-field';
            div.innerHTML = `<input type="text" placeholder="Field Name" class="form-input"><input type="text" placeholder="Field Value" class="form-input"><button type="button" onclick="this.parentElement.remove()">✕</button>`;
            document.getElementById('customFields').appendChild(div);
        }
        
        async function deleteProfile() {
            if (!confirm('Delete your profile? This cannot be undone.')) return;
            await sb.from('profiles').delete().eq('user_id', currentUser.user_id);
            alert('Profile deleted');
            showPage('myProfilePage');
            loadMyProfile();
        }
        
        function showAddPost() {
            document.getElementById('postModal').classList.add('show');
        }
        
        function closePostModal() {
            document.getElementById('postModal').classList.remove('show');
            document.getElementById('postForm').reset();
        }
        
  document.getElementById('postForm').onsubmit = async (e) => {
    e.preventDefault();
    
    const imageFile = document.getElementById('postImage').files[0];
    if (!imageFile) return alert('Please select an image');
    
    // Check your custom authentication
    if (!currentUser || !currentUser.user_id) {
        alert('Please login first');
        return;
    }
    
    try {
        // Create unique filename
        const fileExtension = imageFile.name.split('.').pop();
        const fileName = `posts/${currentUser.user_id}_${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExtension}`;
        
        // Upload file using FormData (bypasses some RLS issues)
        const formData = new FormData();
        formData.append('file', imageFile);
        
        // Direct API call to storage
        const uploadResponse = await fetch(`https://nsnacwwcrszpjmanskti.supabase.co/storage/v1/object/posts/${fileName}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zbmFjd3djcnN6cGptYW5za3RpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MTg2MTIsImV4cCI6MjA2ODQ5NDYxMn0.W01JADzAuGFvcAHAN6LPRIxc75J7A9Q76HIxvxkJDn4`
            },
            body: formData
        });
        
        if (!uploadResponse.ok) {
            const errorText = await uploadResponse.text();
            console.error('Upload failed:', errorText);
            return alert('Upload failed: ' + errorText);
        }
        
        // Construct public URL
        const publicUrl = `https://nsnacwwcrszpjmanskti.supabase.co/storage/v1/object/public/posts/${fileName}`;
        
        // Insert post record
        const { error: insertError } = await sb.from('posts').insert({
            author_id: currentUser.user_id,
            author_type: 'staff',
            image_url: publicUrl,
            caption: document.getElementById('postCaption').value,
            is_published: true
        });
        
        if (insertError) {
            console.error('Insert error:', insertError);
            return alert('Failed to create post: ' + insertError.message);
        }
        
        alert('Post created successfully!');
        closePostModal();
        loadMyProfile();
        
    } catch (error) {
        console.error('Unexpected error:', error);
        alert('Upload failed. Please try again.');
    }
};


        async function deletePost(postId) {
            if (!confirm('Delete this post?')) return;
            await sb.from('posts').delete().eq('post_id', postId);
            loadMyProfile();
        }
        
        async function downloadPDF() {
    try {
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
            return alert('PDF library not loaded. Please refresh the page.');
        }
        
        const doc = new jsPDF();
        
        // Get profile data
        const profileElement = document.getElementById('myProfileContent');
        const headerElement = document.getElementById('myProfileHeader');
        
        if (!profileElement || !headerElement) {
            return alert('Profile data not found');
        }
        
        // Set up PDF styling
        let yPosition = 20;
        const margin = 20;
        const pageWidth = doc.internal.pageSize.width;
        const contentWidth = pageWidth - (margin * 2);
        
        // Add header
        doc.setFontSize(22);
        doc.setTextColor(139, 92, 246); // Purple color
        doc.text('Staff Profile', margin, yPosition);
        yPosition += 15;
        
        // Add a line
        doc.setLineWidth(0.5);
        doc.setDrawColor(139, 92, 246);
        doc.line(margin, yPosition, pageWidth - margin, yPosition);
        yPosition += 15;
        
        // Get profile info
        const nameElement = headerElement.querySelector('.name');
        const deptElement = headerElement.querySelector('.dept');
        
        if (nameElement) {
            doc.setFontSize(18);
            doc.setTextColor(0, 0, 0);
            doc.text(`${nameElement.textContent}`, margin, yPosition);
            yPosition += 12;
        }
        
        if (deptElement) {
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Department: ${deptElement.textContent}`, margin, yPosition);
            yPosition += 15;
        }
        
        // Add profile fields
        const fields = profileElement.querySelectorAll('.profile-field');
        
        fields.forEach(field => {
            const label = field.querySelector('.profile-field-label');
            const value = field.querySelector('.profile-field-value');
            
            if (label && value && value.textContent.trim() !== 'N/A' && value.textContent.trim() !== '') {
                // Check if we need a new page
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Add field label
                doc.setFontSize(11);
                doc.setTextColor(139, 92, 246);
                doc.text(`${label.textContent}:`, margin, yPosition);
                yPosition += 7;
                
                // Add field value with text wrapping
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                const textLines = doc.splitTextToSize(value.textContent, contentWidth);
                doc.text(textLines, margin + 5, yPosition);
                yPosition += (textLines.length * 4) + 8;
            }
        });
        
        // Add footer
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`Page ${i} of ${totalPages}`, pageWidth - 40, doc.internal.pageSize.height - 10);
            doc.text('Generated by VVPIET Staff Portal', margin, doc.internal.pageSize.height - 10);
        }
        
        // Generate filename
        const profileName = nameElement ? 
            nameElement.textContent.replace(/[^a-zA-Z0-9]/g, '_') : 
            'staff_profile';
        
        // Save the PDF
        doc.save(`${profileName}_Profile.pdf`);
        
    } catch (error) {
        console.error('PDF generation error:', error);
        alert('PDF generation failed. Please try again.');
    }
}

        
        async function downloadImage() {
    try {
        if (!window.html2canvas) {
            return alert('Image capture library not loaded. Please refresh the page.');
        }
        
        // Target the entire profile view
        const profileElement = document.getElementById('hasProfile');
        
        if (!profileElement) {
            return alert('Profile not found');
        }
        
        // Show loading message
        const loadingDiv = document.createElement('div');
        loadingDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px;border-radius:10px;z-index:9999;';
        loadingDiv.textContent = 'Generating image...';
        document.body.appendChild(loadingDiv);
        
        // Wait a moment for DOM to settle
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Capture the element
        const canvas = await html2canvas(profileElement, {
            backgroundColor: '#ffffff',
            useCORS: true,
            allowTaint: false,
            scale: 2, // Higher quality
            scrollX: 0,
            scrollY: 0,
            width: profileElement.scrollWidth,
            height: profileElement.scrollHeight,
            logging: false,
            imageTimeout: 15000,
            removeContainer: true
        });
        
        // Remove loading message
        document.body.removeChild(loadingDiv);
        
        // Convert to blob and download
        canvas.toBlob(function(blob) {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Get profile name for filename
            const nameElement = document.querySelector('#myProfileHeader .name');
            const profileName = nameElement ? 
                nameElement.textContent.replace(/[^a-zA-Z0-9]/g, '_') : 
                'staff_profile';
            
            link.href = url;
            link.download = `${profileName}_Profile.png`;
            link.style.display = 'none';
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            
            // Cleanup
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
        }, 'image/png', 1.0);
        
    } catch (error) {
        console.error('Image download error:', error);
        
        // Remove loading message if it exists
        const loadingDiv = document.querySelector('div[style*="position:fixed"]');
        if (loadingDiv) {
            document.body.removeChild(loadingDiv);
        }
        
        alert('Image download failed. Please try again.');
    }
}

        
        function updateAuthText() {
            document.getElementById('authText').textContent = currentUser ? 'Logout' : 'Login';
        }
        
        // Initialize
        const params = new URLSearchParams(location.search);
        if (params.get('dept')) {
            loadDepartment();
        } else if (params.get('tpo')) {
            viewTPO();
        } else if (currentUser) {
            showPage('myProfilePage');
            loadMyProfile();
        } else {
            showPage('loginPage');
        }
        
        loadDepartments();
        updateAuthText();
    </script>
</body>
</html>

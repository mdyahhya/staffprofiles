<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Profiles - VVPIET</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #fff; color: #000; padding-bottom: 80px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; padding: 20px 0; border-bottom: 2px solid #8B5CF6; position: relative; }
        .header h1 { font-size: 24px; color: #8B5CF6; }
        .page { display: none; }
        .page.active { display: block; }
        .back-btn { background: #8B5CF6; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-bottom: 20px; }
        
        .staff-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
        .staff-card { border: 2px solid #8B5CF6; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; transition: transform 0.3s; }
        .staff-card:hover { transform: translateY(-5px); }
        .staff-card img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; }
        .staff-card .name { font-weight: 600; margin: 10px 0 5px; }
        .staff-card .designation { color: #666; font-size: 14px; }
        
        .form-container { max-width: 600px; margin: 0 auto; padding: 30px; background: #f9f9f9; border-radius: 10px; border: 2px solid #8B5CF6; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 2px solid #8B5CF6; border-radius: 8px; font-size: 14px; }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-btn { width: 100%; padding: 15px; background: #8B5CF6; color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .form-btn:hover { opacity: 0.9; }
        
        .profile-view { max-width: 800px; margin: 0 auto; }
        .profile-header { text-align: center; padding: 30px 0; border-bottom: 2px solid #8B5CF6; }
        .profile-header img { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid #8B5CF6; }
        .profile-header .name { font-size: 28px; font-weight: 600; margin: 20px 0 10px; }
        .profile-header .dept { color: #8B5CF6; font-size: 18px; }
        .profile-content { padding: 30px 0; }
        .profile-field { margin-bottom: 25px; }
        .profile-field-label { font-weight: 600; color: #8B5CF6; margin-bottom: 8px; }
        .profile-field-value { color: #333; line-height: 1.6; }
        
        .action-btns { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 30px; }
        .action-btn { flex: 1; min-width: 150px; padding: 12px; border: 2px solid #8B5CF6; background: #fff; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .action-btn:hover { background: #8B5CF6; color: #fff; }
        .delete-btn { border-color: #dc2626; color: #dc2626; }
        .delete-btn:hover { background: #dc2626; color: #fff; }
        
        .taskbar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 2px solid #8B5CF6; display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; }
        .taskbar button { background: none; border: none; cursor: pointer; padding: 8px 20px; font-size: 13px; color: #000; }
        .taskbar .icon { font-size: 20px; margin-bottom: 5px; }
        
        .posts-section { margin-top: 40px; border-top: 2px solid #8B5CF6; padding-top: 30px; }
        .posts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .post-card { border: 2px solid #8B5CF6; border-radius: 10px; overflow: hidden; position: relative; }
        .post-card img { width: 100%; height: 200px; object-fit: cover; }
        .post-card .caption { padding: 15px; }
        .post-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        .post-actions button { background: rgba(255,255,255,0.9); border: none; padding: 8px; border-radius: 5px; cursor: pointer; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: #fff; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; border: 2px solid #8B5CF6; position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; }
        
        input[type="file"] { margin: 15px 0; }
        .custom-field { display: flex; gap: 10px; margin-bottom: 10px; }
        .custom-field input { flex: 1; }
        .custom-field button { padding: 8px 15px; background: #dc2626; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    
        

        /* Enhanced post card styling */
.post-card {
    position: relative;
    border: 2px solid #8B5CF6;
    border-radius: 12px;
    overflow: hidden;
    background: white;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}


.post-image-container {
    position: relative;
    width: 100%;
    height: 200px;
    overflow: hidden;
}

.post-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.post-card:hover .post-img {
    transform: scale(1.05);
}

.post-caption {
    padding: 15px;
    font-size: 14px;
    line-height: 1.4;
    color: #333;
    border-bottom: 1px solid #f0f0f0;
}

.post-actions {
    display: flex;
    justify-content: space-between;
    padding: 10px 15px;
    background: #f8f9fa;
    gap: 10px;
}

.post-actions button {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.edit-btn {
    background: transparent;
    color: black;
}


.delete-btn {
    background: transparent;
    color: black;
}



.post-date {
    padding: 0 15px 10px;
    text-align: right;
}

/* Edit modal specific styling */
.current-image-section {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}

.form-actions {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .post-actions {
        flex-direction: column;
        gap: 8px;
    }
    
    .post-actions button {
        flex: none;
    }
}



/* ADD these new styles */
.dynamic-row {
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    background: #f9f9f9;
}

.row-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #ddd;
}

.row-header h4 {
    color: #8B5CF6;
    margin: 0;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.form-row .form-group {
    margin-bottom: 0;
}

.add-btn {
    background: #8B5CF6;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    margin-bottom: 20px;
    font-weight: 600;
}

.add-btn:hover {
    background: #7C3AED;
}

.remove-btn {
    background: #EF4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.remove-btn:hover {
    background: #DC2626;
}

.custom-project-field {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: white;
}

.custom-project-field .form-row {
    grid-template-columns: 1fr 2fr auto;
    align-items: start;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .custom-project-field .form-row {
        grid-template-columns: 1fr;
    }
}

/* Page visibility control */
.page {
    display: none;
}

.page.active {
    display: block;
}

/* Ensure container is visible */
.container {
    min-height: calc(100vh - 70px);
    padding-bottom: 80px;
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.show {
    display: flex;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 10px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
}

.modal-close {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 30px;
    background: none;
    border: none;
    cursor: pointer;
    color: #666;
}

.modal-close:hover {
    color: #000;
}

/* Dynamic row styles */
.dynamic-row {
    border: 2px solid #8B5CF6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    background: #f9f9f9;
}

.row-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.row-header h4 {
    color: #8B5CF6;
    margin: 0;
}

.remove-btn {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.remove-btn:hover {
    background: #dc2626;
}

.add-btn {
    background: #10b981;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px 20px;
    cursor: pointer;
    margin-bottom: 15px;
}

.add-btn:hover {
    background: #059669;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}

/* Custom field styles */
.custom-field {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.custom-field input {
    flex: 1;
}

.custom-field button {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 0 15px;
    cursor: pointer;
}

.custom-field button:hover {
    background: #dc2626;
}

.custom-project-field {
    border: 1px solid #ddd;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 15px;
    background: white;
}

/* Post card styles */
.post-card {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.post-image-container {
    width: 100%;
    height: 200px;
    overflow: hidden;
}

.post-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.post-caption {
    padding: 15px;
    color: #333;
}

.post-actions {
    display: flex;
    gap: 10px;
    padding: 0 15px 15px;
}

.edit-btn, .delete-btn {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
}



.post-date {
    padding: 0 15px 15px;
    font-size: 12px;
    color: #666;
}

/* Action buttons */
.action-btns {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.action-btn {
    background: #8B5CF6;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px 20px;
    cursor: pointer;
    font-size: 14px;
}

.action-btn:hover {
    background: #7c3aed;
}

.action-btn.delete-btn {
    background: #ef4444;
}

.action-btn.delete-btn:hover {
    background: #dc2626;
}

/* Profile view styles */
.profile-view {
    max-width: 800px;
    margin: 0 auto;
}

.profile-header {
    text-align: center;
    margin-bottom: 30px;
}

.profile-header .name {
    font-size: 24px;
    font-weight: bold;
    margin: 15px 0 5px;
}

.profile-header .dept {
    color: #666;
    font-size: 16px;
}

.profile-field {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 4px solid #8B5CF6;
}

.profile-field-label {
    font-weight: bold;
    color: #8B5CF6;
    margin-bottom: 5px;
}

.profile-field-value {
    color: #333;
    line-height: 1.6;
}

.posts-section {
    margin-top: 40px;
}

.posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

/* Form styles */
.form-container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #333;
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: #8B5CF6;
}

.form-btn {
    width: 100%;
    padding: 12px;
    background: #8B5CF6;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    font-weight: 600;
}

.form-btn:hover {
    background: #7c3aed;
}

/* Back button */
.back-btn {
    background: #6b7280;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 16px;
    cursor: pointer;
    margin-bottom: 20px;
}

.back-btn:hover {
    background: #4b5563;
}

/* Taskbar */
.taskbar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: white;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    z-index: 100;
}

.taskbar button {
    background: none;
    border: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    color: #666;
    padding: 5px 15px;
}

.taskbar button:hover {
    color: #8B5CF6;
}

.taskbar .icon {
    width: 24px;
    height: 24px;
}

.taskbar span {
    font-size: 12px;
}
    




    </style>
</head>
<body>
    <div class="container">
        <!-- Department View -->
        <div id="deptPage" class="page">
            <button class="back-btn" onclick="location.href='index.html'">← Back</button>
            <div class="header">
                <h1 id="deptName">Department</h1>
            </div>
            <h3 style="margin-top:30px;color:#8B5CF6;">Head of Department</h3>
            <div class="staff-grid" id="hodGrid"></div>
            <h3 style="margin-top:30px;color:#8B5CF6;">Staff Members</h3>
            <div class="staff-grid" id="staffGrid"></div>
        </div>
        
        <!-- View Profile (Staff/TPO) -->
        <div id="viewProfilePage" class="page">
            <button class="back-btn" onclick="goBack()">← Back</button>
            <div class="profile-view">
                <div class="profile-header" id="viewProfileHeader"></div>
                <div class="profile-content" id="viewProfileContent"></div>
                <div class="posts-section" id="viewProfilePosts" style="display:none;">
                    <h3 style="color:#8B5CF6;">Posts</h3>
                    <div class="posts-grid" id="viewPostsGrid"></div>
                </div>
            </div>
        </div>
        
        <!-- Login Page -->
        <div id="loginPage" class="page">
            <div class="form-container">
                <button class="back-btn" onclick="location.href='index.html'">← Back</button>
                <h2 style="text-align:center;color:#8B5CF6;margin-bottom:30px;">Staff Login</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="loginPassword" required>
                    </div>
                    <button type="submit" class="form-btn">Login</button>
                </form>
                <p style="text-align:center;margin-top:20px;">New user? <a href="#" onclick="showPage('registerPage');return false;" style="color:#8B5CF6;">Register here</a></p>
            </div>
        </div>
        
        <!-- Register Page -->
        <div id="registerPage" class="page">
            <div class="form-container">
                <button class="back-btn" onclick="showPage('loginPage')">← Back</button>
                <h2 style="text-align:center;color:#8B5CF6;margin-bottom:30px;">Staff Registration</h2>
                <form id="registerForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="regEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="regPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <select class="form-select" id="regDept" required></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department Code (6 digits)</label>
                        <input type="text" class="form-input" id="regCode" maxlength="6" required>
                    </div>
                    <button type="submit" class="form-btn">Register</button>
                    <p style="text-align:center;margin-top:20px;">Registered? <a href="#" onclick="showPage('loginPage');return false;" style="color:#8B5CF6;">Login here</a></p>
                </form>
            </div>
        </div>
        
        <!-- My Profile -->
        <div id="myProfilePage" class="page">
            <button class="back-btn" onclick="location.href='index.html'">← Back</button>
            <div id="noProfile" style="text-align:center;padding:50px;">
                <p style="margin-bottom:20px;">Create your profile to get started.</p>
                <button class="form-btn" style="width:200px;margin:0 auto;" onclick="showPage('createProfilePage')">Create Profile</button>
            </div>
            <div id="hasProfile" style="display:none;">
                <div class="profile-view">
                    <div class="profile-header" id="myProfileHeader"></div>
                    <div class="profile-content" id="myProfileContent"></div>
                    <div class="action-btns">
                        <button class="action-btn" onclick="editProfile()">Edit Profile ✏️</button>
                        <button class="action-btn" onclick="downloadPDF()">Download as PDF 📄</button>
                        <button class="action-btn" onclick="downloadImage()">Download as Image 🖼️</button>
                        <button class="action-btn delete-btn" onclick="deleteProfile()">Delete Profile 🗑️</button>
                    </div>
                    <div class="posts-section">
                        <h3 style="color:#8B5CF6;">My Posts</h3>
                        <button class="form-btn" style="width:200px;margin:20px 0;" onclick="showAddPost()">+ Add Post</button>
                        <div class="posts-grid" id="myPosts"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Create/Edit Profile -->
        <div id="createProfilePage" class="page">
            <div class="form-container">
                <button class="back-btn" onclick="showPage('myProfilePage')">← Back</button>
                <h2 style="text-align:center;color:#8B5CF6;margin-bottom:30px;" id="profileFormTitle">Create Profile</h2>
                <form id="profileForm">
    <!-- Basic Information -->
    <h3 style="color:#8B5CF6;margin-bottom:15px;">Basic Information</h3>
    
    <div class="form-group">
        <label class="form-label">Full Name</label>
        <input type="text" class="form-input" id="profName" required>
    </div>
    
    <div class="form-group">
        <label class="form-label">Date of Birth</label>
        <input type="date" class="form-input" id="profDOB">
    </div>
    
    <div class="form-group">
        <label class="form-label">Department</label>
        <select class="form-select" id="profDept" required></select>
    </div>
    
    <div class="form-group">
        <label class="form-label">Designation</label>
        <select class="form-select" id="profDesig" required>
            <option value="">Select</option>
            <option value="HOD">Head of Department</option>
            <option value="Professor">Professor</option>
            <option value="Associate Professor">Associate Professor</option>
            <option value="Assistant Professor">Assistant Professor</option>
            <option value="Lecturer">Lecturer</option>
        </select>
    </div>
    
    <div class="form-group">
        <label class="form-label">Experience (Years)</label>
        <input type="number" class="form-input" id="profExp" min="0" required>
    </div>
    
    <div class="form-group">
        <label class="form-label">Address</label>
        <textarea class="form-textarea" id="profAddress" rows="3"></textarea>
    </div>
    
    <div class="form-group">
        <label class="form-label">Languages Known (comma separated)</label>
        <input type="text" class="form-input" id="profLanguages" placeholder="English, Hindi, Marathi">
    </div>

    <!-- Educational Qualifications -->
    <h3 style="color:#8B5CF6;margin:30px 0 15px;">Educational Qualifications</h3>
    <div id="educationSection">
        <button type="button" onclick="addEducationRow()" class="add-btn">+ Add Education</button>
        <div id="educationRows"></div>
    </div>


    <!-- PhD Details Section -->
<div class="form-section">
    <h3>PhD Details</h3>
    <div class="form-group">
        <label>PhD Status(Don't select anything if not applicable)</label>
    
        <select id="phdStatus" class="form-select">
            
            <option value="Completed">Completed</option>
            <option value="Pursuing">Pursuing</option>
            <option value="Submitted">Submitted</option>
        </select>
    </div>
    <div class="form-group">
        <label>PhD Title</label>
        <input type="text" id="phdTitle" class="form-input" placeholder="Thesis title">
    </div>
    <div class="form-row">
        <div class="form-group">
            <label>University</label>
            <input type="text" id="phdUniversity" class="form-input" placeholder="University name">
        </div>
        <div class="form-group">
            <label>Year</label>
            <input type="number" id="phdYear" class="form-input" placeholder="2020">
        </div>
    </div>
    <div class="form-group">
        <label>Research Guide</label>
        <input type="text" id="phdGuide" class="form-input" placeholder="Guide name">
    </div>
    <div class="form-group">
        <label>Specialization</label>
        <input type="text" id="phdSpecialization" class="form-input" placeholder="Area of research">
    </div>
</div>

<!-- Patents Section -->
<div class="form-section">
    <h3>Patents</h3>
    <button type="button" class="add-btn" onclick="addPatentRow()">+ Add Patent</button>
    <div id="patentRows"></div>
</div>

<!-- NPTEL Certificates Section -->
<div class="form-section">
    <h3>NPTEL Certificates</h3>
    <button type="button" class="add-btn" onclick="addNPTELRow()">+ Add Certificate</button>
    <div id="nptelRows"></div>
</div>

<!-- Professional Memberships Section -->
<div class="form-section">
    <h3>Professional Memberships</h3>
    <button type="button" class="add-btn" onclick="addMembershipRow()">+ Add Membership</button>
    <div id="membershipRows"></div>
</div>

<!-- Contributions Section -->
<div class="form-section">
    <h3>Contributions (Institute/University/Other)</h3>
    <button type="button" class="add-btn" onclick="addContributionRow()">+ Add Contribution</button>
    <div id="contributionRows"></div>
</div>

<!-- Special Achievements Section -->
<div class="form-section">
    <h3>Special Achievements</h3>
    <button type="button" class="add-btn" onclick="addSpecialAchievementRow()">+ Add Achievement</button>
    <div id="specialAchievementRows"></div>
</div>


    <!-- Experience Profile -->
    <h3 style="color:#8B5CF6;margin:30px 0 15px;">Experience Profile</h3>
    <div id="experienceSection">
        <button type="button" onclick="addExperienceRow()" class="add-btn">+ Add Experience</button>
        <div id="experienceRows"></div>
    </div>

    <!-- Technical Competencies -->
    <h3 style="color:#8B5CF6;margin:30px 0 15px;">Technical Core Competencies</h3>
    
    <div class="form-group">
        <label class="form-label">Programming Languages</label>
        <input type="text" class="form-input" id="techLanguages" placeholder="Java, Python, C++">
    </div>
    
    <div class="form-group">
        <label class="form-label">Software & Tools</label>
        <input type="text" class="form-input" id="techSoftware" placeholder="VS Code, Eclipse, MATLAB">
    </div>
    
    <div class="form-group">
        <label class="form-label">Other Skills</label>
        <input type="text" class="form-input" id="techOthers" placeholder="Machine Learning, Database Design">
    </div>

    <!-- BTech Project -->
    <h3 style="color:#8B5CF6;margin:30px 0 15px;">BTech Project</h3>
    <div id="btechSection">
        <div class="form-group">
            <label class="form-label">Project Title</label>
            <input type="text" class="form-input" id="btechTitle">
        </div>
        <button type="button" onclick="addBtechField()" class="add-btn">+ Add Custom Field</button>
        <div id="btechFields"></div>
    </div>

    <!-- MTech Project -->
    <h3 style="color:#8B5CF6;margin:30px 0 15px;">MTech Project</h3>
    <div id="mtechSection">
        <div class="form-group">
            <label class="form-label">Project Title</label>
            <input type="text" class="form-input" id="mtechTitle">
        </div>
        <button type="button" onclick="addMtechField()" class="add-btn">+ Add Custom Field</button>
        <div id="mtechFields"></div>
    </div>

    <!-- Achievements & Activities -->
    <h3 style="color:#8B5CF6;margin:30px 0 15px;">Achievements & Activities</h3>
    <div id="achievementSection">
        <button type="button" onclick="addAchievementRow()" class="add-btn">+ Add Achievement</button>
        <div id="achievementRows"></div>
    </div>

    <!-- Publications -->
    <h3 style="color:#8B5CF6;margin:30px 0 15px;">Publications</h3>
    <div id="publicationSection">
        <button type="button" onclick="addPublicationRow()" class="add-btn">+ Add Publication</button>
        <div id="publicationRows"></div>
    </div>

    <!-- Existing fields -->
    <div class="form-group">
        <label class="form-label">Research & Expertise</label>
        <textarea class="form-textarea" id="profResearch"></textarea>
    </div>
    
    <div class="form-group">
        <label class="form-label">General Achievements</label>
        <textarea class="form-textarea" id="profAchieve"></textarea>
    </div>
    
    <div class="form-group">
        <label class="form-label">Custom Fields</label>
        <div id="customFields"></div>
        <button type="button" onclick="addCustomField()" style="margin-top:10px;padding:10px 20px;background:#8B5CF6;color:#fff;border:none;border-radius:5px;cursor:pointer;">+ Add Field</button>
    </div>
    
    <div class="form-group">
        <label class="form-label">Profile Image (Optional)</label>
        <input type="file" id="profImage" accept="image/*">
    </div>
    
    <button type="submit" class="form-btn">Save Profile</button>
</form>

            </div>
        </div>
    </div>
    
    <!-- Post Modal -->
    <div class="modal" id="postModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closePostModal()">×</button>
            <h3 style="color:#8B5CF6;margin-bottom:20px;">Add Post</h3>
            <form id="postForm">
                <div class="form-group">
                    <label class="form-label">Image</label>
                    <input type="file" id="postImage" accept="image/*" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Caption</label>
                    <textarea class="form-textarea" id="postCaption"></textarea>
                </div>
                <button type="submit" class="form-btn">Post</button>
            </form>
        </div>
    </div>
    <!-- Edit Post Modal -->
<div class="modal" id="editPostModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeEditPostModal()">×</button>
        <h3 style="color:#8B5CF6;margin-bottom:20px;">Edit Post</h3>
        <form id="editPostForm">
            <div class="current-image-section" style="margin-bottom:20px;">
                <label class="form-label">Current Image</label>
                <div style="text-align:center;">
                    <img id="currentPostImage" src="" alt="Current post" style="max-width:100%;max-height:200px;border-radius:8px;border:2px solid #8B5CF6;">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Change Image (Optional)</label>
                <input type="file" id="editPostImage" accept="image/*">
                <small style="color:#666;">Leave empty to keep current image</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Caption</label>
                <textarea class="form-textarea" id="editPostCaption" rows="4"></textarea>
            </div>
            
            <div class="form-actions" style="display:flex;gap:10px;justify-content:flex-end;">
                <button type="button" onclick="closeEditPostModal()" style="background:#ccc;color:#333;padding:12px 24px;border:none;border-radius:5px;cursor:pointer;">Cancel</button>
                <button type="submit" class="form-btn">Update Post</button>
            </div>
        </form>
    </div>
</div>


    
    <div class="taskbar">
    <button onclick="location.href='index.html'">
        <div class="icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9,22 9,12 15,12 15,22"/>
            </svg>
        </div>
        <span>Home</span>
    </button>
    <button onclick="handleProfile()">
        <div class="icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
        </div>
        <span>Profile</span>
    </button>
    <button onclick="handleAuth()">
        <div class="icon" id="authIcon">
            <!-- LOGIN ICON - Arrow pointing RIGHT (into door) -->
            <svg id="loginIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                <polyline points="10,17 15,12 10,7"/>
                <line x1="15" y1="12" x2="3" y2="12"/>
            </svg>
            <!-- LOGOUT ICON - Arrow pointing LEFT (out of door) -->
            <svg id="logoutIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="display: none;">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16,17 21,12 16,7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
        </div>
        <span id="authText">Login</span>
    </button>
</div>



    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>

const sb = supabase.createClient('https://nsnacwwcrszpjmanskti.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zbmFjd3djcnN6cGptYW5za3RpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MTg2MTIsImV4cCI6MjA2ODQ5NDYxMn0.W01JADzAuGFvcAHAN6LPRIxc75J7A9Q76HIxvxkJDn4');

// ✅ Add helper function
    function hasValue(value) {
        if (value === null || value === undefined) return false;
        if (typeof value === 'string' && (value.trim() === '' || value === 'N/A' || value === 'No data')) return false;
        if (Array.isArray(value) && value.length === 0) return false;
        if (typeof value === 'object' && Object.keys(value).length === 0) return false;
        return true;
    }


let currentUser = JSON.parse(localStorage.getItem('user'));
let editingProfile = false;
let backHistory = [];
let currentEditingPost = null;

// ========================================
// PAGE NAVIGATION FUNCTIONS
// ========================================

function showPage(pageId) {
    const currentPage = document.querySelector('.page.active');
    if (currentPage) {
        backHistory.push(currentPage.id);
    }
    
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const page = document.getElementById(pageId);
    if (page) {
        page.classList.add('active');
    } else {
        console.error(`Page with id "${pageId}" not found.`);
    }
}

function goBack() {
    const prev = backHistory.pop();
    if (prev) showPage(prev);
    else location.href = 'index.html';
}

// ========================================
// DYNAMIC FORM ROW FUNCTIONS (MUST BE DEFINED FIRST!)
// ========================================

function addEducationRow() {
    const container = document.getElementById('educationRows');
    const rowId = Date.now();
    const div = document.createElement('div');
    div.className = 'dynamic-row';
    div.id = `education-${rowId}`;
    div.innerHTML = `
        <div class="row-header">
            <h4>Education ${container.children.length + 1}</h4>
            <button type="button" onclick="removeRow('education-${rowId}')" class="remove-btn">×</button>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Exam/Degree</label>
                <input type="text" class="form-input" name="edu_exam" placeholder="B.Tech, M.Tech, PhD">
            </div>
            <div class="form-group">
                <label class="form-label">Board/University</label>
                <input type="text" class="form-input" name="edu_board">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Marks %</label>
                <input type="number" class="form-input" name="edu_marks" step="0.01" min="0" max="100">
            </div>
            <div class="form-group">
                <label class="form-label">Class Obtained</label>
                <input type="text" class="form-input" name="edu_class" placeholder="First Class, Distinction">
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Year of Passing</label>
            <input type="number" class="form-input" name="edu_year" min="1950" max="2030">
        </div>
    `;
    container.appendChild(div);
}

function addExperienceRow() {
    const container = document.getElementById('experienceRows');
    const rowId = Date.now();
    const div = document.createElement('div');
    div.className = 'dynamic-row';
    div.id = `experience-${rowId}`;
    div.innerHTML = `
        <div class="row-header">
            <h4>Experience ${container.children.length + 1}</h4>
            <button type="button" onclick="removeRow('experience-${rowId}')" class="remove-btn">×</button>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Role/Position</label>
                <input type="text" class="form-input" name="exp_role" required>
            </div>
            <div class="form-group">
                <label class="form-label">Organization</label>
                <input type="text" class="form-input" name="exp_org" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-input" name="exp_start">
            </div>
            <div class="form-group">
                <label class="form-label">End Date</label>
                <input type="date" class="form-input" name="exp_end">
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Duration</label>
            <input type="text" class="form-input" name="exp_duration" placeholder="2 years 3 months">
        </div>
        <div class="form-group">
            <label class="form-label">Key Responsibilities</label>
            <textarea class="form-textarea" name="exp_responsibilities" rows="3"></textarea>
        </div>
    `;
    container.appendChild(div);
}

function addBtechField() {
    const container = document.getElementById('btechFields');
    const fieldId = Date.now();
    const div = document.createElement('div');
    div.className = 'custom-project-field';
    div.id = `btech-field-${fieldId}`;
    div.innerHTML = `
        <div class="form-row">
            <div class="form-group">
                <input type="text" class="form-input" name="btech_heading" placeholder="Field Name (e.g., Objective, Methodology)">
            </div>
            <div class="form-group">
                <textarea class="form-textarea" name="btech_content" placeholder="Content/Answer" rows="3"></textarea>
            </div>
            <button type="button" onclick="removeRow('btech-field-${fieldId}')" class="remove-btn">×</button>
        </div>
    `;
    container.appendChild(div);
}

function addMtechField() {
    const container = document.getElementById('mtechFields');
    const fieldId = Date.now();
    const div = document.createElement('div');
    div.className = 'custom-project-field';
    div.id = `mtech-field-${fieldId}`;
    div.innerHTML = `
        <div class="form-row">
            <div class="form-group">
                <input type="text" class="form-input" name="mtech_heading" placeholder="Field Name (e.g., Objective, Methodology)">
            </div>
            <div class="form-group">
                <textarea class="form-textarea" name="mtech_content" placeholder="Content/Answer" rows="3"></textarea>
            </div>
            <button type="button" onclick="removeRow('mtech-field-${fieldId}')" class="remove-btn">×</button>
        </div>
    `;
    container.appendChild(div);
}

function addAchievementRow() {
    const container = document.getElementById('achievementRows');
    const rowId = Date.now();
    const div = document.createElement('div');
    div.className = 'dynamic-row';
    div.id = `achievement-${rowId}`;
    div.innerHTML = `
        <div class="row-header">
            <h4>Achievement ${container.children.length + 1}</h4>
            <button type="button" onclick="removeRow('achievement-${rowId}')" class="remove-btn">×</button>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" name="ach_category">
                    <option value="achievement">Achievement</option>
                    <option value="award">Award</option>
                    <option value="certification">Certification</option>
                    <option value="activity">Activity</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" class="form-input" name="ach_title" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Organization</label>
                <input type="text" class="form-input" name="ach_org">
            </div>
            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" class="form-input" name="ach_date">
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" name="ach_desc" rows="3"></textarea>
        </div>
    `;
    container.appendChild(div);
}

function addPublicationRow() {
    const container = document.getElementById('publicationRows');
    const rowId = Date.now();
    const div = document.createElement('div');
    div.className = 'dynamic-row';
    div.id = `publication-${rowId}`;
    div.innerHTML = `
        <div class="row-header">
            <h4>Publication ${container.children.length + 1}</h4>
            <button type="button" onclick="removeRow('publication-${rowId}')" class="remove-btn">×</button>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Type</label>
                <select class="form-select" name="pub_type">
                    <option value="journal">Journal Paper</option>
                    <option value="conference">Conference Paper</option>
                    <option value="book">Book/Chapter</option>
                    <option value="patent">Patent</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Publication Date</label>
                <input type="date" class="form-input" name="pub_date">
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Title</label>
            <input type="text" class="form-input" name="pub_title" required>
        </div>
        <div class="form-group">
            <label class="form-label">Authors</label>
            <input type="text" class="form-input" name="pub_authors" placeholder="Author1, Author2, Author3">
        </div>
        <div class="form-group">
            <label class="form-label">Journal/Conference Name</label>
            <input type="text" class="form-input" name="pub_journal">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Volume</label>
                <input type="text" class="form-input" name="pub_volume">
            </div>
            <div class="form-group">
                <label class="form-label">Issue</label>
                <input type="text" class="form-input" name="pub_issue">
            </div>
            <div class="form-group">
                <label class="form-label">Pages</label>
                <input type="text" class="form-input" name="pub_pages">
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">DOI</label>
            <input type="text" class="form-input" name="pub_doi">
        </div>
        <div class="form-group">
            <label class="form-label">Abstract</label>
            <textarea class="form-textarea" name="pub_abstract" rows="4"></textarea>
        </div>
    `;
    container.appendChild(div);
}

// Patent Functions
function addPatentRow() {
    const div = document.createElement('div');
    div.className = 'dynamic-row';
    div.innerHTML = `
        <div class="row-header">
            <h4>Patent Entry</h4>
            <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
        <div class="form-group">
            <label class="form-label">Patent Title *</label>
            <input type="text" name="patent_title" class="form-input" required>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Patent Number</label>
                <input type="text" name="patent_number" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <select name="patent_status" class="form-select">
                    <option value="Filed">Filed</option>
                    <option value="Published">Published</option>
                    <option value="Granted">Granted</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Filing Date</label>
                <input type="date" name="filing_date" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Grant Date</label>
                <input type="date" name="grant_date" class="form-input">
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Inventors</label>
            <input type="text" name="inventors" class="form-input" placeholder="Comma-separated names">
        </div>
        <div class="form-group">
            <label class="form-label">Description</label>
            <textarea name="patent_description" class="form-textarea" rows="3"></textarea>
        </div>
    `;
    document.getElementById('patentRows').appendChild(div);
}

// NPTEL Functions
function addNPTELRow() {
    const div = document.createElement('div');
    div.className = 'dynamic-row';
    div.innerHTML = `
        <div class="row-header">
            <h4>NPTEL Certificate</h4>
            <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
        <div class="form-group">
            <label class="form-label">Course Name *</label>
            <input type="text" name="nptel_course" class="form-input" required>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Domain *</label>
                <input type="text" name="nptel_domain" class="form-input" placeholder="e.g., Machine Learning" required>
            </div>
            <div class="form-group">
                <label class="form-label">Completion Date</label>
                <input type="date" name="nptel_date" class="form-input">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Score/Grade</label>
                <input type="text" name="nptel_score" class="form-input" placeholder="85%">
            </div>
            <div class="form-group">
                <label class="form-label">Certificate URL</label>
                <input type="url" name="nptel_url" class="form-input">
            </div>
        </div>
    `;
    document.getElementById('nptelRows').appendChild(div);
}

// Membership Functions
function addMembershipRow() {
    const div = document.createElement('div');
    div.className = 'dynamic-row';
    div.innerHTML = `
        <div class="row-header">
            <h4>Professional Membership</h4>
            <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
        <div class="form-group">
            <label class="form-label">Organization Name *</label>
            <input type="text" name="membership_org" class="form-input" placeholder="e.g., IEEE, ACM" required>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Membership Type</label>
                <input type="text" name="membership_type" class="form-input" placeholder="e.g., Senior Member">
            </div>
            <div class="form-group">
                <label class="form-label">Membership Number</label>
                <input type="text" name="membership_number" class="form-input">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Start Date</label>
                <input type="date" name="membership_start" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">End Date</label>
                <input type="date" name="membership_end" class="form-input">
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Status</label>
            <select name="membership_status" class="form-select">
                <option value="Active">Active</option>
                <option value="Expired">Expired</option>
                <option value="Lifetime">Lifetime</option>
            </select>
        </div>
    `;
    document.getElementById('membershipRows').appendChild(div);
}

// Contribution Functions
function addContributionRow() {
    const div = document.createElement('div');
    div.className = 'dynamic-row';
    div.innerHTML = `
        <div class="row-header">
            <h4>Contribution</h4>
            <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Level *</label>
                <select name="contribution_level" class="form-select" required>
                    <option value="institute">Institute Level</option>
                    <option value="university">University Level</option>
                    <option value="other">Other Level</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Type *</label>
                <input type="text" name="contribution_type" class="form-input" placeholder="Committee, Event, etc." required>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Title *</label>
            <input type="text" name="contribution_title" class="form-input" required>
        </div>
        <div class="form-group">
            <label class="form-label">Description</label>
            <textarea name="contribution_desc" class="form-textarea" rows="3"></textarea>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">From Date</label>
                <input type="date" name="contribution_from" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">To Date</label>
                <input type="date" name="contribution_to" class="form-input">
            </div>
        </div>
    `;
    document.getElementById('contributionRows').appendChild(div);
}

// Special Achievement Functions
function addSpecialAchievementRow() {
    const div = document.createElement('div');
    div.className = 'dynamic-row';
    div.innerHTML = `
        <div class="row-header">
            <h4>Special Achievement</h4>
            <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
        <div class="form-group">
            <label class="form-label">Achievement Title *</label>
            <input type="text" name="special_ach_title" class="form-input" required>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Type</label>
                <select name="special_ach_type" class="form-select">
                    <option value="award">Award</option>
                    <option value="recognition">Recognition</option>
                    <option value="milestone">Milestone</option>
                    <option value="honor">Honor</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" name="special_ach_date" class="form-input">
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Awarding Body</label>
            <input type="text" name="special_ach_body" class="form-input">
        </div>
        <div class="form-group">
            <label class="form-label">Description</label>
            <textarea name="special_ach_desc" class="form-textarea" rows="3"></textarea>
        </div>
    `;
    document.getElementById('specialAchievementRows').appendChild(div);
}

function removeRow(rowId) {
    const row = document.getElementById(rowId);
    if (row) {
        row.remove();
    }
}

function addCustomField() {
    const div = document.createElement('div');
    div.className = 'custom-field';
    div.innerHTML = `<input type="text" placeholder="Field Name" class="form-input"><input type="text" placeholder="Field Value" class="form-input"><button type="button" onclick="this.parentElement.remove()">✕</button>`;
    document.getElementById('customFields').appendChild(div);
}

// ========================================
// AUTHENTICATION FUNCTIONS
// ========================================

function handleAuth() {
    if (currentUser) {
        if (confirm('Logout?')) {
            localStorage.removeItem('user');
            location.reload();
        }
    } else {
        showPage('loginPage');
    }
}

function handleProfile() {
    if (!currentUser) return showPage('loginPage');
    showPage('myProfilePage');
    loadMyProfile();
}

function updateAuthText() {
    const authText = document.getElementById('authText');
    const loginIcon = document.getElementById('loginIcon');
    const logoutIcon = document.getElementById('logoutIcon');
    
    if (currentUser) {
        if (authText) authText.textContent = 'Logout';
        if (loginIcon) loginIcon.style.display = 'none';
        if (logoutIcon) logoutIcon.style.display = 'block';
    } else {
        if (authText) authText.textContent = 'Login';
        if (loginIcon) loginIcon.style.display = 'block';
        if (logoutIcon) logoutIcon.style.display = 'none';
    }
}

// ========================================
// DEPARTMENT LOADING
// ========================================

async function loadDepartments() {
    const { data } = await sb.from('departments').select('*').order('dept_name');
    const html = '<option value="">Select Department</option>' + (data?.map(d => `<option value="${d.dept_id}">${d.dept_name}</option>`).join('') || '');
    document.querySelectorAll('#regDept, #profDept').forEach(el => el.innerHTML = html);
}

// ========================================
// PROFILE FUNCTIONS  
// ========================================

async function loadMyProfile() {
    try {
        const { data, error } = await sb
            .from('profiles')
            .select('*')
            .eq('user_id', currentUser.user_id)
            .single();
        
        if (error && error.code !== 'PGRST116') {
            console.error('Error loading profile:', error);
        }
        
        if (!data) {
            document.getElementById('noProfile').style.display = 'block';
            document.getElementById('hasProfile').style.display = 'none';
            return;
        }
        
        document.getElementById('noProfile').style.display = 'none';
        document.getElementById('hasProfile').style.display = 'block';
        
        // Get department info
        const { data: dept } = await sb
            .from('departments')
            .select('dept_name')
            .eq('dept_id', data.department)
            .single();
        
        // Create initials and profile image
        const initials = data.name.split(' ').map(n => n[0]).join('').substring(0, 2);
        const img = data.profile_image || `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150'%3E%3Crect fill='%238B5CF6' width='150' height='150'/%3E%3Ctext x='50%25' y='50%25' font-size='60' fill='white' text-anchor='middle' dy='.3em'%3E${initials}%3C/text%3E%3C/svg%3E`;
        
        // Set profile header
        document.getElementById('myProfileHeader').innerHTML = `
            <img src="${img}" alt="${data.name}" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #8B5CF6;">
            <div class="name">${data.name}</div>
            <div class="dept">${dept?.dept_name || ''}</div>
        `;
        
        // Build profile content with basic info
        // Build profile content with basic info
let profileContentHTML = `
    <div class="profile-field">
        <div class="profile-field-label">Designation</div>
        <div class="profile-field-value">${data.designation}</div>
    </div>
    <div class="profile-field">
        <div class="profile-field-label">Experience</div>
        <div class="profile-field-value">${data.experience} years</div>
    </div>
`;

// ✅ Only show Date of Birth if it exists
if (hasValue(data.date_of_birth)) {
    profileContentHTML += `
        <div class="profile-field">
            <div class="profile-field-label">Date of Birth</div>
            <div class="profile-field-value">${new Date(data.date_of_birth).toLocaleDateString()}</div>
        </div>
    `;
}

// ✅ Only show Address if it exists
if (hasValue(data.address)) {
    profileContentHTML += `
        <div class="profile-field">
            <div class="profile-field-label">Address</div>
            <div class="profile-field-value">${data.address}</div>
        </div>
    `;
}

// ✅ Only show Languages if it exists
if (hasValue(data.languages_known)) {
    profileContentHTML += `
        <div class="profile-field">
            <div class="profile-field-label">Languages Known</div>
            <div class="profile-field-value">${data.languages_known.join(', ')}</div>
        </div>
    `;
}

// ✅ PhD SECTION - Only show if ANY field has data
if (hasValue(data.phd_title) || hasValue(data.phd_university) || hasValue(data.phd_year) || 
    hasValue(data.phd_guide) || hasValue(data.phd_specialization)) {
    
    profileContentHTML += `<h3 style="color:#8B5CF6;margin-top:30px;">PhD Details</h3>`;
    
    if (hasValue(data.phd_status)) {
        profileContentHTML += `
            <div class="profile-field">
                <div class="profile-field-label">Status</div>
                <div class="profile-field-value">${data.phd_status}</div>
            </div>
        `;
    }
    
    if (hasValue(data.phd_title)) {
        profileContentHTML += `
            <div class="profile-field">
                <div class="profile-field-label">Thesis Title</div>
                <div class="profile-field-value">${data.phd_title}</div>
            </div>
        `;
    }
    
    if (hasValue(data.phd_university)) {
        profileContentHTML += `
            <div class="profile-field">
                <div class="profile-field-label">University</div>
                <div class="profile-field-value">${data.phd_university}</div>
            </div>
        `;
    }
    
    if (hasValue(data.phd_year)) {
        profileContentHTML += `
            <div class="profile-field">
                <div class="profile-field-label">Year</div>
                <div class="profile-field-value">${data.phd_year}</div>
            </div>
        `;
    }
    
    if (hasValue(data.phd_guide)) {
        profileContentHTML += `
            <div class="profile-field">
                <div class="profile-field-label">Research Guide</div>
                <div class="profile-field-value">${data.phd_guide}</div>
            </div>
        `;
    }
    
    if (hasValue(data.phd_specialization)) {
        profileContentHTML += `
            <div class="profile-field">
                <div class="profile-field-label">Specialization</div>
                <div class="profile-field-value">${data.phd_specialization}</div>
            </div>
        `;
    }
}

// ✅ Only show Research & Expertise if it exists
if (hasValue(data.research_papers)) {
    profileContentHTML += `
        <div class="profile-field">
            <div class="profile-field-label">Research & Expertise</div>
            <div class="profile-field-value">${data.research_papers}</div>
        </div>
    `;
}

// ✅ Only show General Achievements if it exists
if (hasValue(data.achievements)) {
    profileContentHTML += `
        <div class="profile-field">
            <div class="profile-field-label">General Achievements</div>
            <div class="profile-field-value">${data.achievements}</div>
        </div>
    `;
}

// ✅ Only show custom fields if they exist
if (hasValue(data.custom_fields)) {
    profileContentHTML += Object.entries(data.custom_fields)
        .filter(([k, v]) => hasValue(k) && hasValue(v))
        .map(([k, v]) => `
            <div class="profile-field">
                <div class="profile-field-label">${k}</div>
                <div class="profile-field-value">${v}</div>
            </div>
        `).join('');
}

        
        // Load Educational Qualifications
        const { data: educationData } = await sb
            .from('educational_qualifications')
            .select('*')
            .eq('profile_id', data.profile_id);
        
        if (educationData && educationData.length > 0) {
            profileContentHTML += `<h3 style="color:#8B5CF6;margin-top:30px;">Educational Qualifications</h3>`;
            educationData.forEach((edu, index) => {
                profileContentHTML += `
                    <div class="profile-field">
                        <div class="profile-field-label">Education ${index + 1}</div>
                        <div class="profile-field-value">
                            <strong>${edu.exam_name || 'N/A'}</strong><br>
                            ${edu.board_university || 'N/A'}<br>
                            ${edu.marks_percentage ? `Marks: ${edu.marks_percentage}%` : ''} 
                            ${edu.class_obtained ? `(${edu.class_obtained})` : ''}<br>
                            ${edu.year_of_passing ? `Year: ${edu.year_of_passing}` : ''}
                        </div>
                    </div>
                `;
            });
        }
        
        // Load Experience Profile
        const { data: experienceData } = await sb
            .from('experience_profile')
            .select('*')
            .eq('profile_id', data.profile_id);
        
        if (experienceData && experienceData.length > 0) {
            profileContentHTML += `<h3 style="color:#8B5CF6;margin-top:30px;">Experience Profile</h3>`;
            experienceData.forEach((exp, index) => {
                profileContentHTML += `
                    <div class="profile-field">
                        <div class="profile-field-label">Experience ${index + 1}</div>
                        <div class="profile-field-value">
                            <strong>${exp.role || 'N/A'}</strong><br>
                            ${exp.organization || 'N/A'}<br>
                            ${exp.duration || 'N/A'}<br>
                            ${exp.key_responsibilities ? `<em>${exp.key_responsibilities}</em>` : ''}
                        </div>
                    </div>
                `;
            });
        }
        
        // Load Technical Competencies
        const { data: techData } = await sb
            .from('technical_competencies')
            .select('*')
            .eq('profile_id', data.profile_id);
        
        if (techData && techData.length > 0) {
            profileContentHTML += `<h3 style="color:#8B5CF6;margin-top:30px;">Technical Competencies</h3>`;
            
            const languages = techData.filter(t => t.category === 'languages');
            const software = techData.filter(t => t.category === 'software_tools');
            const others = techData.filter(t => t.category === 'other_skills');
            
            if (languages.length > 0) {
                profileContentHTML += `
                    <div class="profile-field">
                        <div class="profile-field-label">Programming Languages</div>
                        <div class="profile-field-value">${languages.map(l => l.competency_name).join(', ')}</div>
                    </div>
                `;
            }
            
            if (software.length > 0) {
                profileContentHTML += `
                    <div class="profile-field">
                        <div class="profile-field-label">Software & Tools</div>
                        <div class="profile-field-value">${software.map(s => s.competency_name).join(', ')}</div>
                    </div>
                `;
            }
            
            if (others.length > 0) {
                profileContentHTML += `
                    <div class="profile-field">
                        <div class="profile-field-label">Other Skills</div>
                        <div class="profile-field-value">${others.map(o => o.competency_name).join(', ')}</div>
                    </div>
                `;
            }
        }
        
        // Load BTech Project
        const { data: btechData } = await sb
            .from('btech_projects')
            .select('*')
            .eq('profile_id', data.profile_id)
            .single();
        
        if (btechData && (btechData.project_title || Object.keys(btechData.project_data || {}).length > 0)) {
            profileContentHTML += `<h3 style="color:#8B5CF6;margin-top:30px;">BTech Project</h3>`;
            
            if (btechData.project_title) {
                profileContentHTML += `
                    <div class="profile-field">
                        <div class="profile-field-label">Project Title</div>
                        <div class="profile-field-value">${btechData.project_title}</div>
                    </div>
                `;
            }
            
            if (btechData.project_data && Object.keys(btechData.project_data).length > 0) {
                Object.entries(btechData.project_data).forEach(([key, value]) => {
                    profileContentHTML += `
                        <div class="profile-field">
                            <div class="profile-field-label">${key}</div>
                            <div class="profile-field-value">${value}</div>
                        </div>
                    `;
                });
            }
        }
        
        // Load MTech Project
        const { data: mtechData } = await sb
            .from('mtech_projects')
            .select('*')
            .eq('profile_id', data.profile_id)
            .single();
        
        if (mtechData && (mtechData.project_title || Object.keys(mtechData.project_data || {}).length > 0)) {
            profileContentHTML += `<h3 style="color:#8B5CF6;margin-top:30px;">MTech Project</h3>`;
            
            if (mtechData.project_title) {
                profileContentHTML += `
                    <div class="profile-field">
                        <div class="profile-field-label">Project Title</div>
                        <div class="profile-field-value">${mtechData.project_title}</div>
                    </div>
                `;
            }
            
            if (mtechData.project_data && Object.keys(mtechData.project_data).length > 0) {
                Object.entries(mtechData.project_data).forEach(([key, value]) => {
                    profileContentHTML += `
                        <div class="profile-field">
                            <div class="profile-field-label">${key}</div>
                            <div class="profile-field-value">${value}</div>
                        </div>
                    `;
                });
            }
        }

        // ✅ LOAD NEW TABLES: Patents, NPTEL, Memberships, Contributions, Special Achievements
        const [
            { data: patents },
            { data: nptel },
            { data: memberships },
            { data: contributions },
            { data: specialAchievements }
        ] = await Promise.all([
            sb.from('patents').select('*').eq('profile_id', data.profile_id),
            sb.from('nptel_certificates').select('*').eq('profile_id', data.profile_id),
            sb.from('professional_memberships').select('*').eq('profile_id', data.profile_id),
            sb.from('contributions').select('*').eq('profile_id', data.profile_id),
            sb.from('special_achievements').select('*').eq('profile_id', data.profile_id)
        ]);

        // Display Patents
        if (patents && patents.length > 0) {
            profileContentHTML += `<h3 style="color:#8B5CF6;margin-top:30px;">Patents</h3>`;
            patents.forEach((patent, index) => {
                profileContentHTML += `
                    <div class="profile-field">
                        <div class="profile-field-label">Patent ${index + 1}</div>
                        <div class="profile-field-value">
                            <strong>${patent.patent_title}</strong><br>
                            ${patent.patent_number ? `Number: ${patent.patent_number}<br>` : ''}
                            ${patent.patent_status ? `Status: ${patent.patent_status}<br>` : ''}
                            ${patent.inventors ? `Inventors: ${patent.inventors}<br>` : ''}
                            ${patent.description ? `<em>${patent.description}</em>` : ''}
                        </div>
                    </div>
                `;
            });
        }

        // Display NPTEL Certificates
        if (nptel && nptel.length > 0) {
            profileContentHTML += `<h3 style="color:#8B5CF6;margin-top:30px;">NPTEL Certificates</h3>`;
            nptel.forEach((cert, index) => {
                profileContentHTML += `
                    <div class="profile-field">
                        <div class="profile-field-label">Certificate ${index + 1}</div>
                        <div class="profile-field-value">
                            <strong>${cert.course_name}</strong><br>
                            Domain: ${cert.domain}<br>
                            ${cert.score ? `Score: ${cert.score}<br>` : ''}
                            ${cert.completion_date ? `Completed: ${new Date(cert.completion_date).toLocaleDateString()}` : ''}
                        </div>
                    </div>
                `;
            });
        }

        // Display Professional Memberships
        if (memberships && memberships.length > 0) {
            profileContentHTML += `<h3 style="color:#8B5CF6;margin-top:30px;">Professional Memberships</h3>`;
            memberships.forEach((mem, index) => {
                profileContentHTML += `
                    <div class="profile-field">
                        <div class="profile-field-label">Membership ${index + 1}</div>
                        <div class="profile-field-value">
                            <strong>${mem.organization_name}</strong><br>
                            ${mem.membership_type ? `Type: ${mem.membership_type}<br>` : ''}
                            ${mem.status ? `Status: ${mem.status}<br>` : ''}
                            ${mem.membership_number ? `Number: ${mem.membership_number}` : ''}
                        </div>
                    </div>
                `;
            });
        }

        // Display Contributions
        if (contributions && contributions.length > 0) {
            profileContentHTML += `<h3 style="color:#8B5CF6;margin-top:30px;">Contributions</h3>`;
            contributions.forEach((contrib, index) => {
                profileContentHTML += `
                    <div class="profile-field">
                        <div class="profile-field-label">Contribution ${index + 1}</div>
                        <div class="profile-field-value">
                            <strong>${contrib.title}</strong><br>
                            Level: ${contrib.contribution_level}<br>
                            Type: ${contrib.contribution_type}<br>
                            ${contrib.description ? `<em>${contrib.description}</em>` : ''}
                        </div>
                    </div>
                `;
            });
        }

        // Display Special Achievements
        if (specialAchievements && specialAchievements.length > 0) {
            profileContentHTML += `<h3 style="color:#8B5CF6;margin-top:30px;">Special Achievements</h3>`;
            specialAchievements.forEach((ach, index) => {
                profileContentHTML += `
                    <div class="profile-field">
                        <div class="profile-field-label">Achievement ${index + 1}</div>
                        <div class="profile-field-value">
                            <strong>${ach.achievement_title}</strong><br>
                            ${ach.achievement_type ? `Type: ${ach.achievement_type}<br>` : ''}
                            ${ach.awarding_body ? `By: ${ach.awarding_body}<br>` : ''}
                            ${ach.description ? `<em>${ach.description}</em>` : ''}
                        </div>
                    </div>
                `;
            });
        }
        
        // Load Achievements & Activities
        const { data: achievementsData } = await sb
            .from('achievements_activities')
            .select('*')
            .eq('profile_id', data.profile_id);
        
        if (achievementsData && achievementsData.length > 0) {
            profileContentHTML += `<h3 style="color:#8B5CF6;margin-top:30px;">Achievements & Activities</h3>`;
            achievementsData.forEach((ach, index) => {
                profileContentHTML += `
                    <div class="profile-field">
                        <div class="profile-field-label">${ach.category} ${index + 1}</div>
                        <div class="profile-field-value">
                            <strong>${ach.title}</strong><br>
                            ${ach.organization ? `${ach.organization}<br>` : ''}
                            ${ach.date_achieved ? `Date: ${new Date(ach.date_achieved).toLocaleDateString()}<br>` : ''}
                            ${ach.description ? `<em>${ach.description}</em>` : ''}
                        </div>
                    </div>
                `;
            });
        }
        
        // Load Publications
        const { data: publicationsData } = await sb
            .from('publications')
            .select('*')
            .eq('profile_id', data.profile_id);
        
        if (publicationsData && publicationsData.length > 0) {
            profileContentHTML += `<h3 style="color:#8B5CF6;margin-top:30px;">Publications</h3>`;
            publicationsData.forEach((pub, index) => {
                profileContentHTML += `
                    <div class="profile-field">
                        <div class="profile-field-label">Publication ${index + 1}</div>
                        <div class="profile-field-value">
                            <strong>${pub.title}</strong><br>
                            ${pub.authors ? `Authors: ${pub.authors}<br>` : ''}
                            ${pub.journal_conference ? `${pub.journal_conference}<br>` : ''}
                            ${pub.publication_type ? `Type: ${pub.publication_type}<br>` : ''}
                            ${pub.publication_date ? `Date: ${new Date(pub.publication_date).toLocaleDateString()}<br>` : ''}
                            ${pub.doi ? `DOI: ${pub.doi}<br>` : ''}
                            ${pub.abstract ? `<em>${pub.abstract}</em>` : ''}
                        </div>
                    </div>
                `;
            });
        }
        
        // Set the complete profile content
        document.getElementById('myProfileContent').innerHTML = profileContentHTML;
        
        // Load posts
        const { data: posts } = await sb
            .from('posts')
            .select('*')
            .eq('author_id', currentUser.user_id)
            .eq('author_type', 'staff')
            .order('created_at', { ascending: false });
        
        document.getElementById('myPosts').innerHTML = posts?.map(post => `
            <div class="post-card" id="post-${post.post_id}">
                <div class="post-image-container">
                    <img src="${post.image_url}" alt="Post" class="post-img">
                </div>
                ${post.caption ? `<div class="post-caption">${post.caption}</div>` : ''}
                <div class="post-actions">
                    <button onclick="editPost(${post.post_id})" class="edit-btn" title="Edit Post">
                        ✏️ Edit
                    </button>
                    <button onclick="deletePost(${post.post_id})" class="delete-btn" title="Delete Post">
                        🗑️ Delete
                    </button>
                </div>
                <div class="post-date" style="font-size:12px;color:#666;margin-top:8px;">
                    ${new Date(post.created_at).toLocaleDateString()}
                </div>
            </div>
        `).join('') || '<p style="text-align:center;color:#666;">No posts yet</p>';
        
    } catch (error) {
        console.error('Profile load error:', error);
        alert('Failed to load profile: ' + error.message);
    }
}

function editProfile() {
    editingProfile = true;
    document.getElementById('profileFormTitle').textContent = 'Edit Profile';
    
    sb.from('profiles').select('*').eq('user_id', currentUser.user_id).single().then(async ({ data }) => {
        if (data) {
            // Basic info
            document.getElementById('profName').value = data.name;
            document.getElementById('profDOB').value = data.date_of_birth || '';
            document.getElementById('profDept').value = data.department;
            document.getElementById('profDesig').value = data.designation;
            document.getElementById('profExp').value = data.experience;
            document.getElementById('profAddress').value = data.address || '';
            document.getElementById('profLanguages').value = data.languages_known ? data.languages_known.join(', ') : '';
            document.getElementById('profResearch').value = data.research_papers || '';
            document.getElementById('profAchieve').value = data.achievements || '';
            
            // ✅ POPULATE PhD FIELDS
            if (document.getElementById('phdStatus')) document.getElementById('phdStatus').value = data.phd_status || '';
            if (document.getElementById('phdTitle')) document.getElementById('phdTitle').value = data.phd_title || '';
            if (document.getElementById('phdUniversity')) document.getElementById('phdUniversity').value = data.phd_university || '';
            if (document.getElementById('phdYear')) document.getElementById('phdYear').value = data.phd_year || '';
            if (document.getElementById('phdGuide')) document.getElementById('phdGuide').value = data.phd_guide || '';
            if (document.getElementById('phdSpecialization')) document.getElementById('phdSpecialization').value = data.phd_specialization || '';
            
           // Custom fields
            const customFieldsDiv = document.getElementById('customFields');
            customFieldsDiv.innerHTML = '';
            if (data.custom_fields) {
                Object.entries(data.custom_fields).forEach(([k, v]) => {
                    const div = document.createElement('div');
                    div.className = 'custom-field';
                    div.innerHTML = `<input type="text" placeholder="Field Name" value="${k}" class="form-input"><input type="text" placeholder="Field Value" value="${v}" class="form-input"><button type="button" onclick="this.parentElement.remove()">✕</button>`;
                    customFieldsDiv.appendChild(div);
                });
            }
            
            // Load and populate education data
            const { data: educationData } = await sb
                .from('educational_qualifications')
                .select('*')
                .eq('profile_id', data.profile_id);
            
            document.getElementById('educationRows').innerHTML = '';
            if (educationData && educationData.length > 0) {
                educationData.forEach((edu) => {
                    addEducationRow();
                    const lastRow = document.getElementById('educationRows').lastChild;
                    lastRow.querySelector('[name="edu_exam"]').value = edu.exam_name || '';
                    lastRow.querySelector('[name="edu_board"]').value = edu.board_university || '';
                    lastRow.querySelector('[name="edu_marks"]').value = edu.marks_percentage || '';
                    lastRow.querySelector('[name="edu_class"]').value = edu.class_obtained || '';
                    lastRow.querySelector('[name="edu_year"]').value = edu.year_of_passing || '';
                });
            }
            
            // Load and populate experience data
            const { data: experienceData } = await sb
                .from('experience_profile')
                .select('*')
                .eq('profile_id', data.profile_id);
            
            document.getElementById('experienceRows').innerHTML = '';
            if (experienceData && experienceData.length > 0) {
                experienceData.forEach((exp) => {
                    addExperienceRow();
                    const lastRow = document.getElementById('experienceRows').lastChild;
                    lastRow.querySelector('[name="exp_role"]').value = exp.role || '';
                    lastRow.querySelector('[name="exp_org"]').value = exp.organization || '';
                    lastRow.querySelector('[name="exp_start"]').value = exp.start_date || '';
                    lastRow.querySelector('[name="exp_end"]').value = exp.end_date || '';
                    lastRow.querySelector('[name="exp_duration"]').value = exp.duration || '';
                    lastRow.querySelector('[name="exp_responsibilities"]').value = exp.key_responsibilities || '';
                });
            }
            
            // Load and populate technical competencies
            const { data: techData } = await sb
                .from('technical_competencies')
                .select('*')
                .eq('profile_id', data.profile_id);
            
            if (techData && techData.length > 0) {
                const languages = techData.filter(t => t.category === 'languages').map(t => t.competency_name);
                const software = techData.filter(t => t.category === 'software_tools').map(t => t.competency_name);
                const others = techData.filter(t => t.category === 'other_skills').map(t => t.competency_name);
                
                document.getElementById('techLanguages').value = languages.join(', ');
                document.getElementById('techSoftware').value = software.join(', ');
                document.getElementById('techOthers').value = others.join(', ');
            }
            
            // Load and populate BTech project
            const { data: btechData } = await sb
                .from('btech_projects')
                .select('*')
                .eq('profile_id', data.profile_id)
                .single();
            
            document.getElementById('btechFields').innerHTML = '';
            if (btechData) {
                document.getElementById('btechTitle').value = btechData.project_title || '';
                if (btechData.project_data && Object.keys(btechData.project_data).length > 0) {
                    Object.entries(btechData.project_data).forEach(([key, value]) => {
                        addBtechField();
                        const lastField = document.getElementById('btechFields').lastChild;
                        lastField.querySelector('[name="btech_heading"]').value = key;
                        lastField.querySelector('[name="btech_content"]').value = value;
                    });
                }
            }
            
            // Load and populate MTech project
            const { data: mtechData } = await sb
                .from('mtech_projects')
                .select('*')
                .eq('profile_id', data.profile_id)
                .single();
            
            document.getElementById('mtechFields').innerHTML = '';
            if (mtechData) {
                document.getElementById('mtechTitle').value = mtechData.project_title || '';
                if (mtechData.project_data && Object.keys(mtechData.project_data).length > 0) {
                    Object.entries(mtechData.project_data).forEach(([key, value]) => {
                        addMtechField();
                        const lastField = document.getElementById('mtechFields').lastChild;
                        lastField.querySelector('[name="mtech_heading"]').value = key;
                        lastField.querySelector('[name="mtech_content"]').value = value;
                    });
                }
            }
            
            // Load and populate achievements
            const { data: achievementsData } = await sb
                .from('achievements_activities')
                .select('*')
                .eq('profile_id', data.profile_id);
            
            document.getElementById('achievementRows').innerHTML = '';
            if (achievementsData && achievementsData.length > 0) {
                achievementsData.forEach((ach) => {
                    addAchievementRow();
                    const lastRow = document.getElementById('achievementRows').lastChild;
                    lastRow.querySelector('[name="ach_category"]').value = ach.category || 'achievement';
                    lastRow.querySelector('[name="ach_title"]').value = ach.title || '';
                    lastRow.querySelector('[name="ach_org"]').value = ach.organization || '';
                    lastRow.querySelector('[name="ach_date"]').value = ach.date_achieved || '';
                    lastRow.querySelector('[name="ach_desc"]').value = ach.description || '';
                });
            }
            
            // Load and populate publications
            const { data: publicationsData } = await sb
                .from('publications')
                .select('*')
                .eq('profile_id', data.profile_id);
            
            document.getElementById('publicationRows').innerHTML = '';
            if (publicationsData && publicationsData.length > 0) {
                publicationsData.forEach((pub) => {
                    addPublicationRow();
                    const lastRow = document.getElementById('publicationRows').lastChild;
                    lastRow.querySelector('[name="pub_type"]').value = pub.publication_type || 'journal';
                    lastRow.querySelector('[name="pub_date"]').value = pub.publication_date || '';
                    lastRow.querySelector('[name="pub_title"]').value = pub.title || '';
                    lastRow.querySelector('[name="pub_authors"]').value = pub.authors || '';
                    lastRow.querySelector('[name="pub_journal"]').value = pub.journal_conference || '';
                    lastRow.querySelector('[name="pub_volume"]').value = pub.volume || '';
                    lastRow.querySelector('[name="pub_issue"]').value = pub.issue || '';
                    lastRow.querySelector('[name="pub_pages"]').value = pub.pages || '';
                    lastRow.querySelector('[name="pub_doi"]').value = pub.doi || '';
                    lastRow.querySelector('[name="pub_abstract"]').value = pub.abstract || '';
                });
            }

                        // ✅ LOAD NEW FIELDS FOR EDITING
            // Load Patents
            const { data: patents } = await sb.from('patents').select('*').eq('profile_id', data.profile_id);
            document.getElementById('patentRows').innerHTML = '';
            if (patents && patents.length > 0) {
                patents.forEach((pat) => {
                    addPatentRow();
                    const lastRow = document.getElementById('patentRows').lastChild;
                    lastRow.querySelector('[name="patent_title"]').value = pat.patent_title || '';
                    lastRow.querySelector('[name="patent_number"]').value = pat.patent_number || '';
                    lastRow.querySelector('[name="filing_date"]').value = pat.filing_date || '';
                    lastRow.querySelector('[name="grant_date"]').value = pat.grant_date || '';
                    lastRow.querySelector('[name="inventors"]').value = pat.inventors || '';
                    lastRow.querySelector('[name="patent_status"]').value = pat.patent_status || 'Filed';
                    lastRow.querySelector('[name="patent_description"]').value = pat.description || '';
                });
            }

            // Load NPTEL Certificates
            const { data: nptel } = await sb.from('nptel_certificates').select('*').eq('profile_id', data.profile_id);
            document.getElementById('nptelRows').innerHTML = '';
            if (nptel && nptel.length > 0) {
                nptel.forEach((cert) => {
                    addNPTELRow();
                    const lastRow = document.getElementById('nptelRows').lastChild;
                    lastRow.querySelector('[name="nptel_course"]').value = cert.course_name || '';
                    lastRow.querySelector('[name="nptel_domain"]').value = cert.domain || '';
                    lastRow.querySelector('[name="nptel_date"]').value = cert.completion_date || '';
                    lastRow.querySelector('[name="nptel_score"]').value = cert.score || '';
                    lastRow.querySelector('[name="nptel_url"]').value = cert.certificate_url || '';
                });
            }

            // Load Professional Memberships
            const { data: memberships } = await sb.from('professional_memberships').select('*').eq('profile_id', data.profile_id);
            document.getElementById('membershipRows').innerHTML = '';
            if (memberships && memberships.length > 0) {
                memberships.forEach((mem) => {
                    addMembershipRow();
                    const lastRow = document.getElementById('membershipRows').lastChild;
                    lastRow.querySelector('[name="membership_org"]').value = mem.organization_name || '';
                    lastRow.querySelector('[name="membership_type"]').value = mem.membership_type || '';
                    lastRow.querySelector('[name="membership_number"]').value = mem.membership_number || '';
                    lastRow.querySelector('[name="membership_start"]').value = mem.start_date || '';
                    lastRow.querySelector('[name="membership_end"]').value = mem.end_date || '';
                    lastRow.querySelector('[name="membership_status"]').value = mem.status || 'Active';
                });
            }

            // Load Contributions
            const { data: contributions } = await sb.from('contributions').select('*').eq('profile_id', data.profile_id);
            document.getElementById('contributionRows').innerHTML = '';
            if (contributions && contributions.length > 0) {
                contributions.forEach((contrib) => {
                    addContributionRow();
                    const lastRow = document.getElementById('contributionRows').lastChild;
                    lastRow.querySelector('[name="contribution_level"]').value = contrib.contribution_level || 'institute';
                    lastRow.querySelector('[name="contribution_type"]').value = contrib.contribution_type || '';
                    lastRow.querySelector('[name="contribution_title"]').value = contrib.title || '';
                    lastRow.querySelector('[name="contribution_desc"]').value = contrib.description || '';
                    lastRow.querySelector('[name="contribution_from"]').value = contrib.date_from || '';
                    lastRow.querySelector('[name="contribution_to"]').value = contrib.date_to || '';
                });
            }

            // Load Special Achievements
            const { data: specialAchievements } = await sb.from('special_achievements').select('*').eq('profile_id', data.profile_id);
            document.getElementById('specialAchievementRows').innerHTML = '';
            if (specialAchievements && specialAchievements.length > 0) {
                specialAchievements.forEach((ach) => {
                    addSpecialAchievementRow();
                    const lastRow = document.getElementById('specialAchievementRows').lastChild;
                    lastRow.querySelector('[name="special_ach_title"]').value = ach.achievement_title || '';
                    lastRow.querySelector('[name="special_ach_type"]').value = ach.achievement_type || 'award';
                    lastRow.querySelector('[name="special_ach_date"]').value = ach.achievement_date || '';
                    lastRow.querySelector('[name="special_ach_body"]').value = ach.awarding_body || '';
                    lastRow.querySelector('[name="special_ach_desc"]').value = ach.description || '';
                });
            }
        }
        showPage('createProfilePage');
    });
}


async function deleteProfile() {
    if (!confirm('Delete your profile? This cannot be undone.')) return;
    
    try {
        // Get profile_id first
        const { data: profile } = await sb
            .from('profiles')
            .select('profile_id')
            .eq('user_id', currentUser.user_id)
            .single();
        
        if (profile) {
            // ✅ UPDATED: Delete all related data including new tables
            await Promise.all([
                sb.from('educational_qualifications').delete().eq('profile_id', profile.profile_id),
                sb.from('experience_profile').delete().eq('profile_id', profile.profile_id),
                sb.from('technical_competencies').delete().eq('profile_id', profile.profile_id),
                sb.from('btech_projects').delete().eq('profile_id', profile.profile_id),
                sb.from('mtech_projects').delete().eq('profile_id', profile.profile_id),
                sb.from('achievements_activities').delete().eq('profile_id', profile.profile_id),
                sb.from('publications').delete().eq('profile_id', profile.profile_id),
                sb.from('posts').delete().eq('author_id', currentUser.user_id).eq('author_type', 'staff'),
                // ✅ DELETE NEW TABLES
                sb.from('patents').delete().eq('profile_id', profile.profile_id),
                sb.from('nptel_certificates').delete().eq('profile_id', profile.profile_id),
                sb.from('professional_memberships').delete().eq('profile_id', profile.profile_id),
                sb.from('contributions').delete().eq('profile_id', profile.profile_id),
                sb.from('special_achievements').delete().eq('profile_id', profile.profile_id)
            ]);
            
            // Delete main profile
            await sb.from('profiles').delete().eq('user_id', currentUser.user_id);
        }
        
        // ✅ CLEAR PROFILE CACHE
        localStorage.removeItem(`profile_${currentUser.user_id}`);
        localStorage.removeItem(`profile_timestamp_${currentUser.user_id}`);
        
        alert('Profile deleted successfully');
        showPage('myProfilePage');
        
        // Reload to show "Create Profile" button
        await loadMyProfile();
        
    } catch (error) {
        console.error('Delete error:', error);
        alert('Failed to delete profile: ' + error.message);
    }
}

// ========================================
// POST FUNCTIONS
// ========================================

function showAddPost() {
    document.getElementById('postModal').classList.add('show');
}

function closePostModal() {
    document.getElementById('postModal').classList.remove('show');
    document.getElementById('postForm').reset();
}

function closeEditPostModal() {
    document.getElementById('editPostModal').classList.remove('show');
    document.getElementById('editPostForm').reset();
    currentEditingPost = null;
}

async function editPost(postId) {
    try {
        const { data: post, error } = await sb
            .from('posts')
            .select('*')
            .eq('post_id', postId)
            .single();
        
        if (error || !post) {
            return alert('Post not found');
        }
        
        if (post.author_id !== currentUser.user_id) {
            return alert('You can only edit your own posts');
        }
        
        currentEditingPost = post;
        
        document.getElementById('currentPostImage').src = post.image_url;
        document.getElementById('editPostCaption').value = post.caption || '';
        document.getElementById('editPostImage').value = '';
        
        document.getElementById('editPostModal').classList.add('show');
        
    } catch (error) {
        console.error('Error fetching post:', error);
        alert('Failed to load post data');
    }
}

async function deletePost(postId) {
    if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
        return;
    }
    
    try {
        const { data: post } = await sb
            .from('posts')
            .select('image_url')
            .eq('post_id', postId)
            .single();
        
        const { error: deleteError } = await sb
            .from('posts')
            .delete()
            .eq('post_id', postId);
        
        if (deleteError) throw deleteError;
        
        if (post?.image_url && !post.image_url.startsWith('data:')) {
            try {
                const fileName = post.image_url.split('/').pop();
                await sb.storage.from('posts').remove([fileName]);
            } catch (storageError) {
                console.log('Could not delete image from storage:', storageError);
            }
        }
        
        alert('Post deleted successfully');
        
        const postElement = document.getElementById(`post-${postId}`);
        if (postElement) {
            postElement.remove();
        }
        
        const postsContainer = document.getElementById('myPosts');
        if (!postsContainer.querySelector('.post-card')) {
            postsContainer.innerHTML = '<p style="text-align:center;color:#666;">No posts yet</p>';
        }
        
    } catch (error) {
        console.error('Error deleting post:', error);
        alert('Failed to delete post: ' + error.message);
    }
}

// ========================================
// PDF AND IMAGE DOWNLOAD
// ========================================

async function downloadPDF() {
    try {
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
            return alert('PDF library not loaded. Please refresh the page.');
        }
        
        // Hide elements we don't want in the PDF
        const actionBtns = document.querySelector('.action-btns');
        const postsSection = document.querySelector('.posts-section');
        const addPostBtn = document.querySelector('button[onclick*="showAddPostModal"]');
        
        const originalActionDisplay = actionBtns ? actionBtns.style.display : '';
        const originalPostsDisplay = postsSection ? postsSection.style.display : '';
        const originalAddPostDisplay = addPostBtn ? addPostBtn.style.display : '';
        
        if (actionBtns) actionBtns.style.display = 'none';
        if (postsSection) postsSection.style.display = 'none';
        if (addPostBtn) addPostBtn.style.display = 'none';
        
        const doc = new jsPDF();
        
        const profileElement = document.getElementById('myProfileContent');
        const headerElement = document.getElementById('myProfileHeader');
        
        if (!profileElement || !headerElement) {
            return alert('Profile data not found');
        }
        
        let yPosition = 20;
        const margin = 20;
        const pageWidth = doc.internal.pageSize.width;
        const contentWidth = pageWidth - (margin * 2);
        
        // Add college logo at top right
        try {
            const logoImg = new Image();
            logoImg.src = 'vvplogo.jpeg';
            await new Promise((resolve, reject) => {
                logoImg.onload = resolve;
                logoImg.onerror = reject;
                setTimeout(reject, 3000); // 3 second timeout
            });
            doc.addImage(logoImg, 'JPEG', pageWidth - 40, 10, 20, 20);
        } catch (e) {
            console.log('Logo not loaded, skipping');
        }
        
        // Header
        doc.setFontSize(22);
        doc.setTextColor(139, 92, 246);
        doc.text('Staff Profile', margin, yPosition);
        yPosition += 15;
        
        doc.setLineWidth(0.5);
        doc.setDrawColor(139, 92, 246);
        doc.line(margin, yPosition, pageWidth - margin, yPosition);
        yPosition += 15;
        
        const nameElement = headerElement.querySelector('.name');
        const deptElement = headerElement.querySelector('.dept');
        
        if (nameElement) {
            doc.setFontSize(18);
            doc.setTextColor(0, 0, 0);
            doc.text(`${nameElement.textContent}`, margin, yPosition);
            yPosition += 12;
        }
        
        if (deptElement) {
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Department: ${deptElement.textContent}`, margin, yPosition);
            yPosition += 15;
        }
        
        // Profile fields
        const fields = profileElement.querySelectorAll('.profile-field');
        
        fields.forEach(field => {
            const label = field.querySelector('.profile-field-label');
            const value = field.querySelector('.profile-field-value');
            
            if (label && value && value.textContent.trim() !== 'N/A' && value.textContent.trim() !== '') {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFontSize(11);
                doc.setTextColor(139, 92, 246);
                doc.text(`${label.textContent}:`, margin, yPosition);
                yPosition += 7;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                const textLines = doc.splitTextToSize(value.textContent, contentWidth);
                doc.text(textLines, margin + 5, yPosition);
                yPosition += (textLines.length * 4) + 8;
            }
        });
        
        // Add footer to all pages
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`Page ${i} of ${totalPages}`, pageWidth - 40, doc.internal.pageSize.height - 10);
            
            // Footer text
            doc.setFontSize(9);
            doc.setTextColor(139, 92, 246);
            const footerText = 'VVPIET Staff Profile at vvpstaff.netlify.app by Continental Base';
            const footerWidth = doc.getTextWidth(footerText);
            doc.text(footerText, (pageWidth - footerWidth) / 2, doc.internal.pageSize.height - 10);
        }
        
        const profileName = nameElement ? 
            nameElement.textContent.replace(/[^a-zA-Z0-9]/g, '_') : 
            'staff_profile';
        
        doc.save(`${profileName}_Profile.pdf`);
        
        // Restore hidden elements
        if (actionBtns) actionBtns.style.display = originalActionDisplay;
        if (postsSection) postsSection.style.display = originalPostsDisplay;
        if (addPostBtn) addPostBtn.style.display = originalAddPostDisplay;
        
    } catch (error) {
        console.error('PDF generation error:', error);
        alert('PDF generation failed. Please try again.');
        
        // Restore on error
        const actionBtns = document.querySelector('.action-btns');
        const postsSection = document.querySelector('.posts-section');
        const addPostBtn = document.querySelector('button[onclick*="showAddPostModal"]');
        if (actionBtns) actionBtns.style.display = '';
        if (postsSection) postsSection.style.display = '';
        if (addPostBtn) addPostBtn.style.display = '';
    }
}


async function downloadImage() {
    try {
        if (!window.html2canvas) {
            return alert('Image capture library not loaded. Please refresh the page.');
        }
        
        // Hide elements we don't want in the image
        const actionBtns = document.querySelector('.action-btns');
        const postsSection = document.querySelector('.posts-section');
        const addPostBtn = document.querySelector('button[onclick*="showAddPostModal"]');
        
        const originalActionDisplay = actionBtns ? actionBtns.style.display : '';
        const originalPostsDisplay = postsSection ? postsSection.style.display : '';
        const originalAddPostDisplay = addPostBtn ? addPostBtn.style.display : '';
        
        if (actionBtns) actionBtns.style.display = 'none';
        if (postsSection) postsSection.style.display = 'none';
        if (addPostBtn) addPostBtn.style.display = 'none';
        
        // Add logo and footer temporarily
        const profileElement = document.getElementById('hasProfile');
        
        if (!profileElement) {
            return alert('Profile not found');
        }
        
        const logo = document.createElement('div');
        logo.id = 'temp-logo';
        logo.style.cssText = 'position:absolute;top:20px;right:20px;z-index:1000;';
        logo.innerHTML = `<img src="vvplogo.jpeg" style="width:80px;height:80px;border-radius:8px;" alt="College Logo">`;
        
        const footer = document.createElement('div');
        footer.id = 'temp-footer';
        footer.style.cssText = 'text-align:center;margin-top:30px;padding:20px;border-top:2px solid #8B5CF6;color:#8B5CF6;font-size:14px;font-weight:600;background:white;';
        footer.innerHTML = 'VVPIET Staff Profile at vvpstaff.netlify.app by Continental Base';
        
        profileElement.style.position = 'relative';
        profileElement.insertBefore(logo, profileElement.firstChild);
        profileElement.appendChild(footer);
        
        // Show loading
        const loadingDiv = document.createElement('div');
        loadingDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px;border-radius:10px;z-index:9999;';
        loadingDiv.textContent = 'Generating image...';
        document.body.appendChild(loadingDiv);
        
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const canvas = await html2canvas(profileElement, {
            backgroundColor: '#ffffff',
            useCORS: true,
            allowTaint: false,
            scale: 2,
            scrollX: 0,
            scrollY: 0,
            width: profileElement.scrollWidth,
            height: profileElement.scrollHeight,
            logging: false,
            imageTimeout: 15000,
            removeContainer: true
        });
        
        document.body.removeChild(loadingDiv);
        
        // Remove temporary elements
        logo.remove();
        footer.remove();
        
        // Restore hidden elements
        if (actionBtns) actionBtns.style.display = originalActionDisplay;
        if (postsSection) postsSection.style.display = originalPostsDisplay;
        if (addPostBtn) addPostBtn.style.display = originalAddPostDisplay;
        
        canvas.toBlob(function(blob) {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const nameElement = document.querySelector('#myProfileHeader .name');
            const profileName = nameElement ? 
                nameElement.textContent.replace(/[^a-zA-Z0-9]/g, '_') : 
                'staff_profile';
            
            link.href = url;
            link.download = `${profileName}_Profile.png`;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
        }, 'image/png', 1.0);
        
    } catch (error) {
        console.error('Image download error:', error);
        
        const loadingDiv = document.querySelector('div[style*="position:fixed"]');
        if (loadingDiv && document.body.contains(loadingDiv)) {
            document.body.removeChild(loadingDiv);
        }
        
        // Clean up temp elements
        const tempLogo = document.getElementById('temp-logo');
        const tempFooter = document.getElementById('temp-footer');
        if (tempLogo) tempLogo.remove();
        if (tempFooter) tempFooter.remove();
        
        // Restore
        const actionBtns = document.querySelector('.action-btns');
        const postsSection = document.querySelector('.posts-section');
        const addPostBtn = document.querySelector('button[onclick*="showAddPostModal"]');
        if (actionBtns) actionBtns.style.display = '';
        if (postsSection) postsSection.style.display = '';
        if (addPostBtn) addPostBtn.style.display = '';
        
        alert('Image download failed. Please try again.');
    }
}


// ========================================
// FORM EVENT HANDLERS (DEFINED AFTER ALL FUNCTIONS)
// ========================================

// Wait for DOM to be ready before attaching event handlers
// Wait for DOM to be ready before attaching event handlers
window.addEventListener('DOMContentLoaded', function() {
    
    // Login Form
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPassword').value;
            
            const { data } = await sb.from('users').select('*').eq('email', email).eq('password', pass).single();
            if (data) {
                localStorage.setItem('user', JSON.stringify(data));
                currentUser = data;
                alert('Login successful!');
                showPage('myProfilePage');
                loadMyProfile();
                updateAuthText();
            } else {
                alert('Invalid credentials');
            }
        };
    }
    
    // Register Form
    document.getElementById('registerForm').onsubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById('regEmail').value;
        const pass = document.getElementById('regPassword').value;
        const dept = document.getElementById('regDept').value;
        const code = document.getElementById('regCode').value;
        
        // Validate department code
        const { data: deptData } = await sb.from('departments').select('*').eq('dept_id', dept).single();
        if (!deptData || deptData.dept_code !== code) {
            return alert('Invalid department code');
        }
        
        // Check if email already exists
        const { data: existingUser } = await sb.from('users').select('email').eq('email', email).single();
        if (existingUser) {
            return alert('This email is already registered. Please login or use a different email.');
        }
        
        // Register new user
        const { error } = await sb.from('users').insert({ 
            email, 
            password: pass, 
            department: dept, 
            role: 'Staff'
        });
        
        if (error) {
            console.error('Registration error:', error);
            return alert('Registration failed: ' + error.message);
        }
        
        alert('Registration successful! Please login.');
        showPage('loginPage');
    };

    // Profile Form
    const profileForm = document.getElementById('profileForm');
    if (profileForm) {
        profileForm.onsubmit = async (e) => {
            e.preventDefault();

            const customFieldsData = {};
            document.querySelectorAll('#customFields .custom-field').forEach(field => {
                const inputs = field.querySelectorAll('input');
                if (inputs[0].value && inputs[1].value) {
                    customFieldsData[inputs[0].value] = inputs[1].value;
                }
            });

            let imageUrl = null;
            const imageFile = document.getElementById('profImage').files[0];

            if (imageFile) {
                try {
                    const fileName = `profiles/${currentUser.user_id}_${Date.now()}_${Math.random().toString(36).substring(7)}.${imageFile.name.split('.').pop()}`;

                    const { data: uploadData, error: uploadError } = await sb.storage
                        .from('profile-images')
                        .upload(fileName, imageFile, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (uploadError) {
                        console.error('Upload error:', uploadError);
                        alert('Image upload failed: ' + uploadError.message);
                        return;
                    }

                    const { data: { publicUrl } } = sb.storage.from('profile-images').getPublicUrl(fileName);
                    imageUrl = publicUrl;

                } catch (error) {
                    console.error('Image upload error:', error);
                    alert('Image upload failed');
                    return;
                }
            }

            // Extract education data
            const educationData = [];
            document.querySelectorAll('#educationRows .dynamic-row').forEach(row => {
                educationData.push({
                    exam_name: row.querySelector('[name="edu_exam"]').value,
                    board_university: row.querySelector('[name="edu_board"]').value,
                    marks_percentage: parseFloat(row.querySelector('[name="edu_marks"]').value) || null,
                    class_obtained: row.querySelector('[name="edu_class"]').value,
                    year_of_passing: parseInt(row.querySelector('[name="edu_year"]').value) || null,
                });
            });

            // Extract experience data
            const experienceData = [];
            document.querySelectorAll('#experienceRows .dynamic-row').forEach(row => {
                experienceData.push({
                    role: row.querySelector('[name="exp_role"]').value,
                    organization: row.querySelector('[name="exp_org"]').value,
                    duration: row.querySelector('[name="exp_duration"]').value,
                    start_date: row.querySelector('[name="exp_start"]').value || null,
                    end_date: row.querySelector('[name="exp_end"]').value || null,
                    key_responsibilities: row.querySelector('[name="exp_responsibilities"]').value,
                });
            });

            // Extract technical competencies
            const techCompetencies = [
                ...document.getElementById('techLanguages').value.split(',').map(v => ({ category: "languages", competency_name: v.trim() })),
                ...document.getElementById('techSoftware').value.split(',').map(v => ({ category: "software_tools", competency_name: v.trim() })),
                ...document.getElementById('techOthers').value.split(',').map(v => ({ category: "other_skills", competency_name: v.trim() }))
            ].filter(v => v.competency_name);

            // Extract BTech project data
            const btechFields = {};
            document.querySelectorAll('#btechFields .custom-project-field').forEach(field => {
                const key = field.querySelector('[name="btech_heading"]').value;
                const value = field.querySelector('[name="btech_content"]').value;
                if (key) btechFields[key] = value;
            });
            const btechData = {
                project_title: document.getElementById('btechTitle').value,
                project_data: btechFields,
            };

            // Extract MTech project data
            const mtechFields = {};
            document.querySelectorAll('#mtechFields .custom-project-field').forEach(field => {
                const key = field.querySelector('[name="mtech_heading"]').value;
                const value = field.querySelector('[name="mtech_content"]').value;
                if (key) mtechFields[key] = value;
            });
            const mtechData = {
                project_title: document.getElementById('mtechTitle').value,
                project_data: mtechFields,
            };

            // Extract achievements & activities
            const achievementEntries = [];
            document.querySelectorAll('#achievementRows .dynamic-row').forEach(row => {
                achievementEntries.push({
                    category: row.querySelector('[name="ach_category"]').value,
                    title: row.querySelector('[name="ach_title"]').value,
                    organization: row.querySelector('[name="ach_org"]').value,
                    date_achieved: row.querySelector('[name="ach_date"]').value || null,
                    description: row.querySelector('[name="ach_desc"]').value,
                });
            });

            // Extract publications
            const publicationEntries = [];
            document.querySelectorAll('#publicationRows .dynamic-row').forEach(row => {
                publicationEntries.push({
                    publication_type: row.querySelector('[name="pub_type"]').value,
                    title: row.querySelector('[name="pub_title"]').value,
                    authors: row.querySelector('[name="pub_authors"]').value,
                    journal_conference: row.querySelector('[name="pub_journal"]').value,
                    publication_date: row.querySelector('[name="pub_date"]').value || null,
                    doi: row.querySelector('[name="pub_doi"]').value,
                    isbn: '',
                    pages: row.querySelector('[name="pub_pages"]').value,
                    volume: row.querySelector('[name="pub_volume"]').value,
                    issue: row.querySelector('[name="pub_issue"]').value,
                    abstract: row.querySelector('[name="pub_abstract"]').value,
                });
            });

            // ✅ EXTRACT NEW FIELDS DATA
            // Extract Patents
            const patentsData = [];
            document.querySelectorAll('#patentRows .dynamic-row').forEach(row => {
                patentsData.push({
                    patent_title: row.querySelector('[name="patent_title"]').value,
                    patent_number: row.querySelector('[name="patent_number"]').value || null,
                    filing_date: row.querySelector('[name="filing_date"]').value || null,
                    grant_date: row.querySelector('[name="grant_date"]').value || null,
                    inventors: row.querySelector('[name="inventors"]').value || null,
                    patent_status: row.querySelector('[name="patent_status"]').value || null,
                    description: row.querySelector('[name="patent_description"]').value || null
                });
            });

            // Extract NPTEL Certificates
            const nptelData = [];
            document.querySelectorAll('#nptelRows .dynamic-row').forEach(row => {
                nptelData.push({
                    course_name: row.querySelector('[name="nptel_course"]').value,
                    domain: row.querySelector('[name="nptel_domain"]').value,
                    completion_date: row.querySelector('[name="nptel_date"]').value || null,
                    score: row.querySelector('[name="nptel_score"]').value || null,
                    certificate_url: row.querySelector('[name="nptel_url"]').value || null
                });
            });

            // Extract Professional Memberships
            const membershipsData = [];
            document.querySelectorAll('#membershipRows .dynamic-row').forEach(row => {
                membershipsData.push({
                    organization_name: row.querySelector('[name="membership_org"]').value,
                    membership_type: row.querySelector('[name="membership_type"]').value || null,
                    membership_number: row.querySelector('[name="membership_number"]').value || null,
                    start_date: row.querySelector('[name="membership_start"]').value || null,
                    end_date: row.querySelector('[name="membership_end"]').value || null,
                    status: row.querySelector('[name="membership_status"]').value || 'Active'
                });
            });

            // Extract Contributions
            const contributionsData = [];
            document.querySelectorAll('#contributionRows .dynamic-row').forEach(row => {
                contributionsData.push({
                    contribution_level: row.querySelector('[name="contribution_level"]').value,
                    contribution_type: row.querySelector('[name="contribution_type"]').value,
                    title: row.querySelector('[name="contribution_title"]').value,
                    description: row.querySelector('[name="contribution_desc"]').value || null,
                    date_from: row.querySelector('[name="contribution_from"]').value || null,
                    date_to: row.querySelector('[name="contribution_to"]').value || null
                });
            });

            // Extract Special Achievements
            const specialAchievementsData = [];
            document.querySelectorAll('#specialAchievementRows .dynamic-row').forEach(row => {
                specialAchievementsData.push({
                    achievement_title: row.querySelector('[name="special_ach_title"]').value,
                    achievement_type: row.querySelector('[name="special_ach_type"]').value || null,
                    awarding_body: row.querySelector('[name="special_ach_body"]').value || null,
                    achievement_date: row.querySelector('[name="special_ach_date"]').value || null,
                    description: row.querySelector('[name="special_ach_desc"]').value || null
                });
            });

            // Main profile data object
            const profileData = {
                user_id: currentUser.user_id,
                name: document.getElementById('profName').value,
                department: parseInt(document.getElementById('profDept').value),
                designation: document.getElementById('profDesig').value,
                experience: parseInt(document.getElementById('profExp').value),
                research_papers: document.getElementById('profResearch').value,
                achievements: document.getElementById('profAchieve').value,
                custom_fields: customFieldsData,
                date_of_birth: document.getElementById('profDOB').value || null,
                address: document.getElementById('profAddress').value || null,
                languages_known: document.getElementById('profLanguages').value.split(',').map(l => l.trim()).filter(Boolean),
                is_published: true,
                
                // ✅ ADD PhD FIELDS
                phd_status: document.getElementById('phdStatus')?.value || null,
                phd_title: document.getElementById('phdTitle')?.value || null,
                phd_university: document.getElementById('phdUniversity')?.value || null,
                phd_year: document.getElementById('phdYear')?.value ? parseInt(document.getElementById('phdYear').value) : null,
                phd_guide: document.getElementById('phdGuide')?.value || null,
                phd_specialization: document.getElementById('phdSpecialization')?.value || null
            };

            if (imageUrl) {
                profileData.profile_image = imageUrl;
            }

            try {
                let savedProfile;
                if (editingProfile) {
                    const { data, error } = await sb.from('profiles').update(profileData).eq('user_id', currentUser.user_id).select('profile_id').single();
                    if (error) throw error;
                    savedProfile = data;
                } else {
                    const { data, error } = await sb.from('profiles').insert(profileData).select('profile_id').single();
                    if (error) throw error;
                    savedProfile = data;
                }

                const profile_id = savedProfile.profile_id;

                // Education
                await sb.from('educational_qualifications').delete().eq('profile_id', profile_id);
                if (educationData.length) await sb.from('educational_qualifications').insert(
                    educationData.map(e => ({ ...e, profile_id }))
                );

                // Experience
                await sb.from('experience_profile').delete().eq('profile_id', profile_id);
                if (experienceData.length) await sb.from('experience_profile').insert(
                    experienceData.map(e => ({ ...e, profile_id }))
                );

                // Technical competencies
                await sb.from('technical_competencies').delete().eq('profile_id', profile_id);
                if (techCompetencies.length) await sb.from('technical_competencies').insert(
                    techCompetencies.map(e => ({ ...e, profile_id }))
                );

                // BTech project
                await sb.from('btech_projects').delete().eq('profile_id', profile_id);
                if (btechData.project_title || Object.keys(btechData.project_data).length) {
                    await sb.from('btech_projects').insert([{ ...btechData, profile_id }]);
                }

                // MTech project
                await sb.from('mtech_projects').delete().eq('profile_id', profile_id);
                if (mtechData.project_title || Object.keys(mtechData.project_data).length) {
                    await sb.from('mtech_projects').insert([{ ...mtechData, profile_id }]);
                }

                // Achievements & activities
                await sb.from('achievements_activities').delete().eq('profile_id', profile_id);
                if (achievementEntries.length) {
                    await sb.from('achievements_activities').insert(
                        achievementEntries.map(a => ({ ...a, profile_id }))
                    );
                }

                // Publications
                await sb.from('publications').delete().eq('profile_id', profile_id);
                if (publicationEntries.length) {
                    await sb.from('publications').insert(
                        publicationEntries.map(p => ({ ...p, profile_id }))
                    );
                }

                // ✅ SAVE NEW TABLES
                // Patents
                await sb.from('patents').delete().eq('profile_id', profile_id);
                if (patentsData.length) {
                    await sb.from('patents').insert(
                        patentsData.map(p => ({ ...p, profile_id }))
                    );
                }

                // NPTEL Certificates
                await sb.from('nptel_certificates').delete().eq('profile_id', profile_id);
                if (nptelData.length) {
                    await sb.from('nptel_certificates').insert(
                        nptelData.map(n => ({ ...n, profile_id }))
                    );
                }

                // Professional Memberships
                await sb.from('professional_memberships').delete().eq('profile_id', profile_id);
                if (membershipsData.length) {
                    await sb.from('professional_memberships').insert(
                        membershipsData.map(m => ({ ...m, profile_id }))
                    );
                }

                // Contributions
                await sb.from('contributions').delete().eq('profile_id', profile_id);
                if (contributionsData.length) {
                    await sb.from('contributions').insert(
                        contributionsData.map(c => ({ ...c, profile_id }))
                    );
                }

                // Special Achievements
                await sb.from('special_achievements').delete().eq('profile_id', profile_id);
                if (specialAchievementsData.length) {
                    await sb.from('special_achievements').insert(
                        specialAchievementsData.map(s => ({ ...s, profile_id }))
                    );
                }

                // ✅ Clear cache
                localStorage.removeItem(`profile_${currentUser.user_id}`);
                localStorage.removeItem(`profile_timestamp_${currentUser.user_id}`);

                alert('Profile saved successfully!');
                editingProfile = false;
                showPage('myProfilePage');
                loadMyProfile();

            } catch (error) {
                console.error('Profile save error:', error);
                alert('Failed to save profile: ' + error.message);
            }
        };
    }
    
    // Post Form
    const postForm = document.getElementById('postForm');
    if (postForm) {
        postForm.onsubmit = async (e) => {
            e.preventDefault();
            
            const imageFile = document.getElementById('postImage').files[0];
            if (!imageFile) return alert('Please select an image');
            
            if (!currentUser || !currentUser.user_id) {
                alert('Please login first');
                return;
            }
            
            try {
                const fileExtension = imageFile.name.split('.').pop();
                const fileName = `posts/${currentUser.user_id}_${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExtension}`;
                
                const formData = new FormData();
                formData.append('file', imageFile);
                
                const uploadResponse = await fetch(`https://nsnacwwcrszpjmanskti.supabase.co/storage/v1/object/posts/${fileName}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zbmFjd3djcnN6cGptYW5za3RpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MTg2MTIsImV4cCI6MjA2ODQ5NDYxMn0.W01JADzAuGFvcAHAN6LPRIxc75J7A9Q76HIxvxkJDn4`
                    },
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    const errorText = await uploadResponse.text();
                    console.error('Upload failed:', errorText);
                    return alert('Upload failed: ' + errorText);
                }
                
                const publicUrl = `https://nsnacwwcrszpjmanskti.supabase.co/storage/v1/object/public/posts/${fileName}`;
                
                const { error: insertError } = await sb.from('posts').insert({
                    author_id: currentUser.user_id,
                    author_type: 'staff',
                    image_url: publicUrl,
                    caption: document.getElementById('postCaption').value,
                    is_published: true
                });
                
                if (insertError) {
                    console.error('Insert error:', insertError);
                    return alert('Failed to create post: ' + insertError.message);
                }
                
                // ✅ Clear cache after post creation
                localStorage.removeItem(`profile_${currentUser.user_id}`);
                localStorage.removeItem(`profile_timestamp_${currentUser.user_id}`);
                
                alert('Post created successfully!');
                closePostModal();
                loadMyProfile();
                
            } catch (error) {
                console.error('Unexpected error:', error);
                alert('Upload failed. Please try again.');
            }
        };
    }
    
    // Edit Post Form
    const editPostForm = document.getElementById('editPostForm');
    if (editPostForm) {
        editPostForm.onsubmit = async (e) => {
            e.preventDefault();
            
            if (!currentEditingPost) {
                return alert('No post selected for editing');
            }
            
            try {
                const newCaption = document.getElementById('editPostCaption').value;
                const newImageFile = document.getElementById('editPostImage').files[0];
                
                let updateData = {
                    caption: newCaption,
                    updated_at: new Date().toISOString()
                };
                
                if (newImageFile) {
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'Uploading...';
                    submitBtn.disabled = true;
                    
                    const fileName = `posts/${currentUser.user_id}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${newImageFile.name.split('.').pop()}`;
                    
                    const { data: uploadData, error: uploadError } = await sb.storage
                        .from('posts')
                        .upload(fileName, newImageFile);
                    
                    if (uploadError) {
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        throw uploadError;
                    }
                    
                    const { data: { publicUrl } } = sb.storage.from('posts').getPublicUrl(fileName);
                    updateData.image_url = publicUrl;
                    
                    try {
                        const oldFileName = currentEditingPost.image_url.split('/').pop();
                        await sb.storage.from('posts').remove([oldFileName]);
                    } catch (deleteError) {
                        console.log('Could not delete old image:', deleteError);
                    }
                    
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
                
                const { error: updateError } = await sb
                    .from('posts')
                    .update(updateData)
                    .eq('post_id', currentEditingPost.post_id);
                
                if (updateError) throw updateError;
                
                // ✅ Clear cache after post update
                localStorage.removeItem(`profile_${currentUser.user_id}`);
                localStorage.removeItem(`profile_timestamp_${currentUser.user_id}`);
                
                alert('Post updated successfully! 🎉');
                closeEditPostModal();
                loadMyProfile();
                
            } catch (error) {
                console.error('Error updating post:', error);
                alert('Failed to update post: ' + error.message);
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Update Post';
                    submitBtn.disabled = false;
                }
            }
        };
    }


    
    // ========================================
    // INITIALIZE APPLICATION
    // ========================================
    
    loadDepartments();
    updateAuthText();
    
    const params = new URLSearchParams(location.search);
    
    if (params.get('dept')) {
        // Load department view (if needed)
    } else if (params.get('tpo')) {
        // Load TPO view (if needed)
    } else if (currentUser) {
        showPage('myProfilePage');
        loadMyProfile();
    } else {
        showPage('loginPage');
    }
});
</script>
</body>
</html>
